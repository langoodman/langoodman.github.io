<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- æ ¸å¿ƒé€‚é…ï¼šè®¾ç½®è§†å£ï¼Œç¦æ­¢ç¼©æ”¾ï¼Œé€‚é…åˆ˜æµ·å±/çµåŠ¨å²› -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA iOS æ ¸å¿ƒè®¾ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å…¨èƒ½è®°è´¦">
    <meta name="format-detection" content="telephone=no">
    
    <title>å…¨èƒ½è®°è´¦æœ¬ - PWAç‰ˆ</title>
    
    <!-- å¼•å…¥ XLSX è§£æåº“ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ ECharts å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- å¼•å…¥ SortableJS æ‹–æ‹½åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- åŠ¨æ€ç”Ÿæˆ PWA Icon å’Œ Manifest -->
    <script>
        const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="background:#2563eb"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="300" font-family="sans-serif">Â¥</text></svg>`;
        const iconUrl = "data:image/svg+xml;base64," + btoa(iconSvg);
        const link = document.createElement('link'); link.rel = 'apple-touch-icon'; link.href = iconUrl; document.head.appendChild(link);
        const manifest = { "name": "å…¨èƒ½è®°è´¦æœ¬", "short_name": "è®°è´¦", "start_url": ".", "display": "standalone", "background_color": "#f8fafc", "theme_color": "#f1f5f9", "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/svg+xml" }] };
        const manifestLink = document.createElement('link'); manifestLink.rel = 'manifest'; manifestLink.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest)); document.head.appendChild(manifestLink);
    </script>

    <style>
        :root {
            --primary: #2563eb; --primary-hover: #1d4ed8;
            --purple: #7c3aed; --purple-hover: #6d28d9;
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --special: #f59e0b; 
            --bg: #f8fafc; --card-bg: #ffffff; --border: #e2e8f0;
            --text-main: #0f172a; --text-sub: #64748b;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* åŸºç¡€é‡ç½®ä¸å­—ä½“ */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.5; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1280px; margin: 0 auto; background: var(--card-bg); border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); min-height: 85vh; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* é¡¶éƒ¨æ  */
        .top-bar { display: flex; justify-content: flex-end; background: #f1f5f9; padding: 8px 15px; border-bottom: 1px solid var(--border); gap: 10px; }
        .top-link { font-size: 0.85rem; color: var(--text-sub); text-decoration: none; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: 0.2s; user-select: none;}
        
        /* Tabs å¯¼èˆª */
        .tabs { display: flex; background: #f1f5f9; border-bottom: 1px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: 600; color: var(--text-sub); transition: 0.2s; user-select: none; white-space: nowrap; min-width: 80px; position: relative; }
        .tab:hover { background: #e2e8f0; }
        .tab.active { background: var(--card-bg); color: var(--primary); border-top: 4px solid var(--primary); }
        .tab[onclick*="special"].active { color: var(--special); border-top-color: var(--special); }
        .tab[onclick*="projects"].active { color: var(--purple); border-top-color: var(--purple); }

        /* å†…å®¹åŒºåŸŸ */
        .tab-content { display: none; padding: 30px; flex: 1; animation: fadeIn 0.3s ease; padding-bottom: 80px; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* æŒ‰é’®æ ·å¼ */
        .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; color: white; white-space: nowrap; touch-action: manipulation; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); } 
        .btn-purple { background: var(--purple); } 
        .btn-danger { background: var(--danger); } 
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { border: 1px solid var(--border); background: white; color: var(--text-main); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; border-radius: 6px; }
        .btn-star { background: transparent; border: none; font-size: 1.4rem; cursor: pointer; padding: 5px; color: #cbd5e1; transition: 0.2s; }
        .btn-star.active { color: #f59e0b; }

        /* è¡¨å•æ§ä»¶ */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 0; align-items: start; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; transition: 0.2s; box-sizing: border-box; background: #fff; appearance: none; -webkit-appearance: none; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .form-control:disabled { background: #f1f5f9; color: #94a3b8; }
        input[type="date"] { cursor: pointer; min-height: 44px; }
        select.form-control { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 1.5em; }

        .input-group { position: relative; display: flex; align-items: center; gap: 8px; }
        .dropdown-menu { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 50; max-height: 250px; overflow-y: auto; display: none; margin-top: 5px; }
        .dropdown-menu.show { display: block; animation: fadeIn 0.1s ease; }
        .dropdown-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; color: var(--text-main); font-size: 1rem; }
        
        /* è¾“å…¥æŠ˜å é¢æ¿æ ·å¼ (æ·»åŠ  box-sizing é˜²æ­¢æ’‘ç ´å®¹å™¨) */
        .input-toggle-btn { 
            width: 100%; 
            box-sizing: border-box;
            padding: 12px; 
            background: white; 
            border: 1px dashed #cbd5e1; 
            color: var(--text-sub); 
            border-radius: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 8px; 
            transition: 0.2s; 
            margin-bottom: 15px; 
            font-size: 1rem; 
        }
        .input-toggle-btn:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }
        .input-toggle-btn.active { background: var(--primary); color: white; border-style: solid; border-color: var(--primary); }
        .input-area-wrapper { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.3s cubic-bezier(0, 1, 0, 1), opacity 0.3s ease; margin-bottom: 0; }
        .input-area-wrapper.open { max-height: 1000px; opacity: 1; transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in; margin-bottom: 25px; }
        .input-card { background: #f8fafc; border: 1px solid var(--border); border-radius: 12px; padding: 15px; }

        /* è¡¨æ ¼ä¼˜åŒ– */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { 
            text-align: left; 
            padding: 12px 10px; 
            border-bottom: 1px solid var(--border); 
            white-space: nowrap;
        }
        th { background: #f8fafc; font-weight: 600; color: var(--text-sub); font-size: 0.9rem; }
        td { font-size: 0.95rem; }
        .amount-cell { font-family: 'Consolas', monospace; font-weight: 700; color: var(--text-main); }

        /* åˆ†å‰²çº¿ä¸å¡ç‰‡ */
        .year-separator { margin: 30px 0 15px; font-weight: 800; font-size: 1.2rem; color: var(--text-sub); display: flex; align-items: center; gap: 15px; }
        .year-separator::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        
        .plan-card { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; overflow: hidden; background: white; transition: box-shadow 0.2s; }
        
        /* è®¡åˆ’/å½’çº³ å¡ç‰‡å¤´éƒ¨ - ä¿®å¤æŒ¤å‹é—®é¢˜ */
        .plan-header { 
            padding: 15px 15px; 
            display: flex; 
            flex-direction: column; 
            background: #fff; 
            cursor: pointer; 
            user-select: none; 
            border-bottom: 1px solid transparent; 
            gap: 12px; 
            //min-height: 44px; 
        }
        .plan-header.row-only {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
        .plan-card:not(.collapsed) .plan-header { border-bottom-color: var(--border); background: #f8fafc; }
        
        /* å¤´éƒ¨ç¬¬ä¸€è¡Œï¼šåç§° + æ€»é‡‘é¢ */
        .plan-header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            flex-wrap: wrap; /* å…³é”®ï¼šå…è®¸æ¢è¡Œ */
            gap: 8px; /* æ¢è¡Œåçš„é—´è· */
        }
        .plan-header-top .header-left {
            display: flex;
            align-items: center;
            /* å…³é”®ï¼šå–æ¶ˆ flex:1ï¼Œå…è®¸æ ¹æ®å†…å®¹å®½åº¦è‡ªé€‚åº”ï¼Œé˜²æ­¢æŒ¤å‹ */
            /* overflow: hidden; åˆ é™¤è¿™è¡Œï¼Œé˜²æ­¢å›¾æ ‡è¢«åˆ‡æ‰ */
            white-space: nowrap; /* é˜²æ­¢åç§°æ¢è¡Œ */
        }
        .plan-header-top .header-right {
            white-space: nowrap; 
            text-align: right;
            flex-shrink: 0;
            margin-left: auto; /* é å³å¯¹é½ï¼Œé…åˆ flex-wrap å³ä½¿æ¢è¡Œä¹Ÿä¼šé å³ */
            font-size: 0.85rem; /* ç¨å¾®ç¼©å°é‡‘é¢å­—ä½“é€‚é…ç§»åŠ¨ç«¯ */
        }

        .plan-header-actions { display: flex; gap: 8px; width: 100%; justify-content: space-between; }
        .plan-header-actions button { flex: 1; padding: 8px 0; font-size: 0.9rem; }
        
        /* é€šç”¨æŠ˜å å›¾æ ‡ */
        .toggle-icon { transition: transform 0.3s ease; margin-right: 8px; color: var(--text-sub); display: inline-block; font-size: 0.8rem; }
        .plan-card.collapsed .toggle-icon, .analysis-month-group.collapsed .toggle-icon { transform: rotate(-90deg); }
        
        /* æŠ˜å éšè—å†…å®¹æ ¸å¿ƒé€»è¾‘ */
        .plan-card.collapsed .plan-items, 
        .plan-card.collapsed .plan-header-actions,
        .analysis-month-group.collapsed .analysis-days-container { 
            display: none !important; 
        }

        .plan-items { padding: 15px; background: white; animation: slideDown 0.2s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* === è®¡åˆ’é¡¹ç›®æ˜ç»†æ ·å¼ === */
        .plan-items-header { display: none; }
        .plan-item-card {
            background: #fff; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03); overflow: hidden;
        }
        .plan-item-header {
            padding: 12px; background: #fff; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; border-bottom: 1px solid transparent; user-select: none;
        }
        .plan-item-card.expanded .plan-item-header { background: #f8fafc; border-bottom-color: var(--border); }
        .item-header-info { display: flex; align-items: center; font-weight: 500; color: var(--text-main); }
        .item-toggle-icon { font-size: 0.75rem; color: #94a3b8; margin-right: 8px; transition: 0.2s; transform: rotate(-90deg); }
        .plan-item-card.expanded .item-toggle-icon { transform: rotate(0deg); }
        .item-header-amount { font-family: 'Consolas', monospace; font-weight: bold; color: var(--text-sub); }
        .plan-item-body { padding: 15px; display: none; }
        .plan-item-card.expanded .plan-item-body { display: block; animation: slideDown 0.2s ease; }
        .plan-item-row { display: flex; flex-wrap: wrap; gap: 10px; width: 100%; align-items: flex-start; }
        .plan-item-input-group { flex: 1 1 45%; min-width: 100px; display: flex; flex-direction: column; gap: 4px; }
        .plan-item-input-group label { font-size: 0.75rem; color: var(--text-sub); margin-left: 2px; }
        .plan-item-actions { display: flex; gap: 8px; justify-content: flex-end; width: 100%; border-top: 1px dashed #f1f5f9; padding-top: 10px; margin-top: 15px; }
        .plan-item-actions button { flex: 1; }
        
        /* === æ¡Œé¢ç«¯é€‚é… === */
        @media screen and (min-width: 769px) {
            .plan-items-header { display: grid; gap: 10px; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border); font-weight: bold; color: var(--text-sub); font-size: 0.9rem; }
            .grid-budget-header { grid-template-columns: 1.5fr 0.8fr 0.8fr 0.5fr 1.5fr 1.1fr 130px; }
            .grid-project-header { grid-template-columns: 1.5fr 1fr 2fr 1.2fr 130px; }
            .plan-item-card { display: grid; gap: 10px; align-items: center; padding: 8px 0; margin-bottom: 0; border: none; border-bottom: 1px dashed var(--border); border-radius: 0; box-shadow: none; background: transparent; overflow: visible; }
            .plan-item-card:last-child { border-bottom: none; }
            .plan-item-header { display: none; } 
            .plan-item-body { display: contents !important; padding: 0; } 
            .grid-budget-row { display: grid; grid-template-columns: 1.5fr 0.8fr 0.8fr 0.5fr 1.5fr 1.1fr 130px; gap: 10px; width: 100%;}
            .grid-project-row { display: grid; grid-template-columns: 1.5fr 1fr 2fr 1.2fr 130px; gap: 10px; width: 100%;}
            .plan-item-input-group label { display: none; } 
            .plan-item-actions { width: auto; border: none; padding: 0; margin: 0; }
            .plan-item-actions button { flex: none; width: auto; }
        }

        /* ç»Ÿè®¡ä¸åˆ†ææ ·å¼ */
        .analysis-month-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; position: relative; overflow: hidden; border-radius: 6px; margin-bottom: 4px; background: transparent; }
        .row-content { width: 100%; display: flex; justify-content: space-between; font-weight: 500; color: #475569; }
        .analysis-day-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 10px 10px 35px; border-bottom: 1px dashed var(--border); color: var(--text-sub); font-size: 0.95rem; }
        .special-badge { font-size: 0.75rem; background: #fffbeb; color: #b45309; padding: 2px 6px; border-radius: 4px; border: 1px solid #fcd34d; margin-left: 5px; }
        .source-tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; color: #fff; display: inline-block; transform: scale(0.9); }
        .source-daily { background: #3b82f6; } .source-special { background: #f59e0b; } 

        /* å¼¹çª—ä¸Toast */
        #toast-container { position: fixed; bottom: calc(30px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); z-index: 2000; pointer-events: none; width: 90%; text-align: center;}
        .toast { background: rgba(15, 23, 42, 0.95); color: white; padding: 12px 24px; border-radius: 50px; margin-top: 10px; font-size: 1rem; opacity: 0; transform: translateY(20px); transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: inline-block; backdrop-filter: blur(5px); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); padding: 20px; }
        .modal { background: white; padding: 25px; border-radius: 20px; width: 450px; max-width: 100%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); transform: scale(0.95); animation: popIn 0.2s forwards; max-height: 85vh; overflow-y: auto; }
        @keyframes popIn { to { transform: scale(1); } }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .analysis-toolbar { display: flex; gap: 15px; align-items: flex-end; justify-content: flex-start; flex-wrap: wrap; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; }
        
        /* ä¿®å¤ï¼šåˆ†é¡µç»„ä»¶æ ·å¼ (å¼ºåˆ¶ä¸€è¡Œ) */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 20px; padding: 10px 0; flex-wrap: nowrap; width: 100%; }
        .page-btn { background: white; border: 1px solid var(--border); padding: 8px 15px; border-radius: 8px; cursor: pointer; color: var(--text-main); font-size: 0.9rem;}

        .charts-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .chart-card { background: white; padding: 10px; border-radius: 12px; border: 1px solid var(--border); height: 350px; }

        /* ä¿®å¤ç»Ÿè®¡é¡µé¢ç™½è¾¹ï¼šä½¿ç”¨å¡ç‰‡å¸ƒå±€æ’‘æ»¡å®½åº¦ */
        #analysis-result h3 { margin: 15px 0 10px; font-size: 1rem; }
        .ranking-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; width: 100%; }
        .ranking-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; flex-direction: column; height: 100%; }
        .ranking-card h4 { margin: 0 0 10px 0; padding-bottom: 8px; border-bottom: 1px dashed var(--border); font-size: 1rem; text-align: center; }
        /* å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶è¡¨æ ¼100%å®½åº¦ */
        .ranking-card table { margin-top: 0; width: 100%; table-layout: fixed; }
        .ranking-card th, .ranking-card td { padding: 8px 5px; }

        /* åˆ†ç±»ç®¡ç†æ ·å¼ */
        .category-manager-container { max-height: 50vh; overflow-y: auto; padding: 5px; }
        .cat-card { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .cat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #e2e8f0; cursor: move; }
        .tag-item { background: #f1f5f9; color: var(--text-sub); padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; border: 1px solid transparent; transition: 0.2s; cursor: move; margin-bottom: 5px;}
        .manage-tag-item { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 8px; }
        .icon-btn { padding: 5px 10px; font-size: 1.2rem; }

        /* --- ç§»åŠ¨ç«¯æ·±åº¦é€‚é… --- */
        @media screen and (max-width: 768px) {
            body { padding: 0; background: #fff; }
            .container { margin: 0; border-radius: 0; box-shadow: none; min-height: 100vh; padding-bottom: calc(20px + var(--safe-bottom)); }
            .top-bar { padding-top: calc(10px + var(--safe-top)); padding-bottom: 10px; justify-content: space-between; background: rgba(241, 245, 249, 0.95); backdrop-filter: blur(10px); position: sticky; top:0; z-index:100; }
            .tabs { position: sticky; top: 55px; z-index: 99; background: rgba(241, 245, 249, 0.98); backdrop-filter: blur(10px); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
            .tab { padding: 15px 10px; font-size: 0.95rem; }
            .tab-content { padding: 15px 15px 80px 15px; }
            h2 { font-size: 1.2rem; margin-top: 10px; flex-wrap: wrap; gap: 10px; }
            h2 div { width: 100%; justify-content: flex-start; margin-top: 5px; overflow-x: auto; padding-bottom: 5px; }
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
            .btn { min-height: 44px; }
            
            /* å…³é”®ä¿®å¤ï¼šæŸ¥è¯¢åˆ—è¡¨è¡¨æ ¼å¼ºåˆ¶å…¨å®½ï¼Œä¸ä½¿ç”¨blockå¸ƒå±€ */
            table { display: table; width: 100%; } 
            /* æŸ¥è¯¢åˆ—è¡¨çš„å®¹å™¨å…è®¸æ¨ªå‘æ»šåŠ¨ï¼Œä½†é»˜è®¤å®½åº¦100% */
            #daily-analysis-list-view > div { overflow-x: auto; width: 100%; }
            
            /* ç¼©å°å•å…ƒæ ¼å·¦å³paddingï¼Œç¡®ä¿5åˆ—èƒ½æ”¾ä¸‹ */
            th, td { padding: 12px 4px; font-size: 0.85rem; }
            
            .analysis-toolbar { flex-direction: column; align-items: stretch; }
            .analysis-toolbar > div { width: 100% !important; }
            .charts-wrapper { grid-template-columns: 1fr; }
            .modal { width: 95%; max-height: 80vh; padding: 20px; }
            
            /* ç§»åŠ¨ç«¯åˆ†é¡µæŒ‰é’®ä¼˜åŒ– (ç´§å‡‘æ¨¡å¼) */
            .page-btn { padding: 6px 10px; font-size: 0.85rem; white-space: nowrap; }
            .page-info { font-size: 0.8rem; white-space: nowrap; margin: 0 2px; }
            .page-size-select { font-size: 0.85rem; padding: 6px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <label class="top-link" title="ä»æ–‡ä»¶æ¢å¤æ•°æ®" style="padding: 5px 10px; background: white; border-radius: 20px; border: 1px solid #e2e8f0;">
            ğŸ“‚ æ¢å¤æ•°æ®<input type="file" id="import-file" style="display:none" onchange="app.restoreData(this)" accept=".json">
        </label>
        <a class="top-link" onclick="app.backupData()" title="ä¸‹è½½æ‰€æœ‰æ•°æ®æ–‡ä»¶åˆ°æœ¬åœ°" style="padding: 5px 10px; background: white; border-radius: 20px; border: 1px solid #e2e8f0;">
            ğŸ’¾ å¤‡ä»½æ•°æ®
        </a>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="app.switchTab('daily')">è®°è´¦</div>
        <div class="tab" onclick="app.switchTab('daily-analysis')">æŸ¥è¯¢</div>
        <div class="tab" onclick="app.switchTab('special')">ç‰¹åˆ«</div>
        <div class="tab" onclick="app.switchTab('budgets')">é¢„ç®—</div>
        <div class="tab" onclick="app.switchTab('projects')">å¤§é¢</div>
        <div class="tab" onclick="app.switchTab('analysis')">ç»Ÿè®¡</div>
    </div>

    <!-- 1. æ—¥å¸¸è®°è´¦ -->
    <div id="tab-daily" class="tab-content active">
        <h2 style="display:flex; justify-content:space-between; align-items:center;">
            ä»Šæ—¥è´¦å•
            <div style="display:flex; gap:8px;">
                <button class="btn btn-outline btn-sm" onclick="app.openCategoryModal()">âš™ï¸ åˆ†ç±»</button>
                <button class="btn btn-success btn-sm" onclick="app.exportDaily()">ğŸ“¤ å¯¼å‡º</button>
                <button class="btn btn-warning btn-sm" onclick="app.clearDayData()">ğŸ—‘ï¸ æ¸…ç©ºä»Šæ—¥</button>
            </div>
        </h2>

        <!-- æŠ˜å å¼è®°è´¦é¢æ¿ -->
        <div id="daily-input-toggle" class="input-toggle-btn" onclick="app.toggleInputForm('daily-input-wrapper', this)">
            <span>+ è®°ä¸€ç¬”</span>
        </div>

        <div id="daily-input-wrapper" class="input-area-wrapper">
            <div class="input-card">
                <div class="form-grid">
                    <div><label>æ—¥æœŸ</label><input type="date" id="daily-date" class="form-control" onchange="app.loadDailyRecords()" onclick="try{this.showPicker()}catch(e){}"></div>
                    <div><label>ä¸€çº§åˆ†ç±»</label><select id="daily-l1" class="form-control" onchange="app.updateL2Options()"></select></div>
                    <div><label>äºŒçº§åˆ†ç±»</label><select id="daily-l2" class="form-control"></select></div>
                    <div style="grid-column: span 1;">
                        <label>å¤‡æ³¨ (é€‰å¡«)</label>
                        <div class="input-group">
                            <div style="position: relative; flex: 1;">
                                <input type="text" id="daily-note" class="form-control" placeholder="" autocomplete="off" onclick="app.toggleNoteDropdown(true); event.stopPropagation();">
                                <span id="note-toggle-icon" onclick="app.toggleNoteDropdown(true); event.stopPropagation();" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #94a3b8; font-size: 0.8rem; padding: 10px;">â–¼</span>
                                <div id="note-dropdown" class="dropdown-menu"></div>
                            </div>
                            <button class="btn btn-outline" onclick="app.openNoteManager()" title="ç®¡ç†å¿«æ·çŸ­è¯­" style="padding: 10px;">âš™ï¸</button>
                        </div>
                    </div>
                    <div><label>é‡‘é¢</label><input type="number" id="daily-amount" class="form-control" placeholder="0.00" step="0.01" inputmode="decimal"></div>
                    <button class="btn btn-primary" id="daily-submit-btn" onclick="app.addOrUpdateRecord()" style="height:48px; margin-top:24px; font-size: 1.1rem;">è®°ä¸€ç¬”</button>
                </div>
            </div>
        </div>

        <div style="overflow-x: auto; border-radius: 8px; border: 1px solid var(--border);">
            <table id="daily-table">
                <thead><tr><th width="15%">åˆ†ç±»</th><th width="15%">å­é¡¹</th><th width="35%">å¤‡æ³¨</th><th width="20%">é‡‘é¢</th><th width="15%">æ“ä½œ</th></tr></thead>
                <tbody id="daily-tbody"></tbody>
                <tfoot><tr style="background:#f8fafc"><td colspan="3" style="text-align: right; font-weight: bold;">åˆè®¡:</td><td id="daily-total" class="amount-cell" style="font-size:1.1rem; color:var(--primary)">0.00</td><td></td></tr></tfoot>
            </table>
        </div>
    </div>

    <!-- 1.5. æ—¥å¸¸å½’çº³åˆ†æ -->
    <div id="tab-daily-analysis" class="tab-content">
        <h2>ğŸ“ˆ æ¶ˆè´¹æŸ¥è¯¢</h2>
        <div class="analysis-mode-switch" style="display:flex; gap:0; border:1px solid var(--border); border-radius:8px; overflow:hidden; margin-bottom:15px; width:fit-content;">
            <button class="mode-btn active" id="mode-timeline" onclick="app.changeAnalysisMode('timeline')" style="padding:10px 20px; border:none; background:white;">ğŸ“… æ—¶é—´å½’çº³</button>
            <button class="mode-btn" id="mode-list" onclick="app.changeAnalysisMode('list')" style="padding:10px 20px; border:none; background:white;">ğŸ” åˆ†ç±»æ˜ç»†</button>
        </div>
        <div class="analysis-toolbar">
            <div style="display:flex; flex-direction:column; gap:5px; flex:1; min-width: 200px;">
                <span style="font-size:0.85rem; font-weight:bold; color:var(--text-sub)">ğŸ“… æ—¥æœŸèŒƒå›´:</span>
                <div style="display:flex; gap:10px; align-items:center">
                    <input type="date" id="da-start" class="form-control" onchange="app.handleAnalysisDateChange()">
                    <span>è‡³</span>
                    <input type="date" id="da-end" class="form-control" onchange="app.handleAnalysisDateChange()">
                </div>
            </div>
            <div id="da-category-filters" style="display:none; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                <div style="display:flex; flex-direction:column; gap:5px; width: 48%;">
                    <span style="font-size:0.85rem; font-weight:bold; color:var(--text-sub)">ä¸€çº§:</span>
                    <select id="da-l1" class="form-control" onchange="app.updateDaL2Options()"><option value="">å…¨éƒ¨</option></select>
                </div>
                <div style="display:flex; flex-direction:column; gap:5px; width: 48%;">
                    <span style="font-size:0.85rem; font-weight:bold; color:var(--text-sub)">äºŒçº§:</span>
                    <select id="da-l2" class="form-control"><option value="">å…¨éƒ¨</option></select>
                </div>
                <button class="btn btn-primary" onclick="app.searchDailyDetails(1)" style="width:100%">æŸ¥è¯¢</button>
                <button class="btn btn-success" onclick="app.exportDailyAnalysisList()" style="width:100%">ğŸ“¤ å¯¼å‡ºç»“æœ</button>
            </div>
            <div style="flex:1; text-align:right; align-self: center; width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <div style="font-size:0.9rem; color:var(--text-sub)">æ€»è®¡</div>
                <div id="da-total-amount" style="font-size:1.5rem; font-weight:bold; color:var(--primary)">Â¥0.00</div>
            </div>
        </div>
        <div id="daily-analysis-timeline"></div>
        <div id="daily-analysis-list-view" style="display:none;">
            <div style="overflow-x:auto">
                <table id="da-list-table"><thead><tr><th>æ—¥æœŸ</th><th>ä¸€çº§</th><th>äºŒçº§</th><th>å¤‡æ³¨</th><th>é‡‘é¢</th></tr></thead><tbody id="da-list-tbody"></tbody></table>
            </div>
            <div id="da-pagination" class="pagination" style="display:none;">
                <button class="page-btn" onclick="app.changeDaPage(-1)">ä¸Šä¸€é¡µ</button>
                <span class="page-info" id="da-page-info">1 / 1</span>
                <button class="page-btn" onclick="app.changeDaPage(1)">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <!-- ğŸŒŸ ç‰¹åˆ«æ”¯å‡º -->
    <div id="tab-special" class="tab-content">
        <h2 style="display:flex; justify-content:space-between; align-items:center;">
            ğŸŒŸ ç‰¹åˆ«æ”¯å‡º
            <div style="display:flex; gap:10px">
                <button class="btn btn-warning btn-sm" onclick="app.clearSpecialItems()">ğŸ—‘ï¸ æ¸…ç©º</button>
                <button class="btn btn-success btn-sm" onclick="app.exportSpecial()">ğŸ“¤ å¯¼å‡º</button>
            </div>
        </h2>
        
        <!-- æŠ˜å å¼è®°è´¦é¢æ¿ -->
        <div id="special-input-toggle" class="input-toggle-btn" onclick="app.toggleInputForm('special-input-wrapper', this)">
            <span>+ è®°ä¸€ç¬” (ç‹¬ç«‹)</span>
        </div>

        <div id="special-input-wrapper" class="input-area-wrapper">
            <div class="input-card">
                <div class="form-grid">
                    <div><label>æ—¥æœŸ</label><input type="date" id="special-date" class="form-control"></div>
                    <div><label>åç§°</label><input type="text" id="special-name" class="form-control" placeholder="ä¾‹å¦‚ï¼šçº¢åŒ…"></div>
                    <div style="grid-column: span 1;"><label>å¤‡æ³¨</label><input type="text" id="special-note" class="form-control" placeholder="é€‰å¡«"></div>
                    <div><label>é‡‘é¢</label><input type="number" id="special-amount" class="form-control" placeholder="0.00" step="0.01" inputmode="decimal"></div>
                    <button class="btn btn-warning" onclick="app.addSpecialItem()" style="height:48px; margin-top:24px">è®°ä¸€ç¬” (ç‹¬ç«‹)</button>
                </div>
            </div>
        </div>
        
        <div style="background:#fffbeb; border:1px solid #fcd34d; padding:10px; border-radius:8px; margin-bottom:20px; font-size:0.85rem; color:#92400e; line-height: 1.4; margin-top: 20px;">
            ğŸ’¡ <b>æ•°æ®æ¥æºï¼š</b><br>
            1. <b>æ—¥å¸¸è®°è´¦</b>ï¼šåˆ—è¡¨ç‚¹äº®æ˜Ÿæ˜Ÿ ğŸŒŸã€‚<br>
            2. <b>ç‹¬ç«‹è®°å½•</b>ï¼šä¸Šæ–¹è¾“å…¥ï¼Œä¸è®¡å…¥æ—¥å¸¸æ€»é¢ã€‚
        </div>

        <div id="special-container" style="margin-top:20px;"></div>
    </div>

    <!-- 2. é¢„ç®—è®¡åˆ’ -->
    <div id="tab-budgets" class="tab-content">
        <h2 style="display:flex; justify-content:space-between; align-items:center;">
            é¢„ç®—è®¡åˆ’
            <div style="display:flex; gap:10px">
                <button class="btn btn-success btn-sm" onclick="app.exportPlans('budget')">ğŸ“¤ å¯¼å‡º</button>
                <button class="btn btn-primary btn-sm" onclick="app.openPlanModal('add', 'budget')">+ æ–°å¢</button>
                <button class="btn btn-warning btn-sm" onclick="app.clearPlans('budget')">ğŸ—‘ï¸</button>
            </div>
        </h2>
        <div id="budgets-container"></div>
        <div id="budget-pagination" class="pagination" style="display:none;">
            <select class="page-size-select" id="budget-page-size" onchange="app.renderBudgets(1)" style="padding:8px; border:1px solid var(--border); border-radius:6px;"><option value="5">5ä¸ª/é¡µ</option><option value="10">10ä¸ª/é¡µ</option></select>
            <button class="page-btn" onclick="app.changePlanPage('budget', -1)">ä¸Šä¸€é¡µ</button><span class="page-info" id="budget-page-info"></span><button class="page-btn" onclick="app.changePlanPage('budget', 1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- 3. å¤§é¢æ”¯å‡º -->
    <div id="tab-projects" class="tab-content">
        <h2 style="display:flex; justify-content:space-between; align-items:center;">
            å¤§é¢æ”¯å‡º
            <div style="display:flex; gap:10px">
                <button class="btn btn-success btn-sm" onclick="app.exportPlans('project')">ğŸ“¤ å¯¼å‡º</button>
                <button class="btn btn-purple btn-sm" onclick="app.openPlanModal('add', 'project')">+ æ–°å¢</button>
                <button class="btn btn-warning btn-sm" onclick="app.clearPlans('project')">ğŸ—‘ï¸</button>
            </div>
        </h2>
        <div id="projects-container"></div>
        <div id="project-pagination" class="pagination" style="display:none;">
            <select class="page-size-select" id="project-page-size" onchange="app.renderProjects(1)" style="padding:8px; border:1px solid var(--border); border-radius:6px;"><option value="5">5ä¸ª/é¡µ</option><option value="10">10ä¸ª/é¡µ</option></select>
            <button class="page-btn" onclick="app.changePlanPage('project', -1)">ä¸Šä¸€é¡µ</button><span class="page-info" id="project-page-info"></span><button class="page-btn" onclick="app.changePlanPage('project', 1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- 4. å…¨å±€æ•°æ®åˆ†æ -->
    <div id="tab-analysis" class="tab-content">
        <h2>ğŸ“Š ç»Ÿè®¡åˆ†æ</h2>
        <div class="analysis-toolbar">
            <div style="display:flex; flex-direction:column; gap:5px; flex:1">
                <span style="font-size:0.85rem; font-weight:bold; color:var(--text-sub)">ğŸ“… æ—¶é—´èŒƒå›´:</span>
                <div style="display:flex; gap:10px; align-items:center">
                    <input type="date" id="analysis-start" class="form-control" onchange="app.triggerAnalysis()">
                    <span>è‡³</span>
                    <input type="date" id="analysis-end" class="form-control" onchange="app.triggerAnalysis()">
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:5px; width: 120px;">
                <span style="font-size:0.85rem; font-weight:bold; color:var(--text-sub)">ğŸ† å‰ N é¡¹:</span>
                <input type="number" id="analysis-top-n" class="form-control" value="10" min="1" max="50" onchange="app.triggerAnalysis()">
            </div>
            <div style="width: 100%; border-top: 1px dashed #eee; padding-top: 10px;">
                <label class="btn btn-outline btn-primary" style="width: 100%; box-sizing: border-box; cursor:pointer; display:flex; flex-direction:column; gap:2px; height:auto; padding:12px;">
                    <span>ğŸ“‚ åˆ†æè´¦å•æ–‡ä»¶å¤¹ (Excel)</span>
                    <input type="file" id="folder-input" webkitdirectory directory multiple style="display:none" onchange="app.analyzeFiles(this)">
                </label>
            </div>
        </div>
        <div id="analysis-result" style="display: none;">
            <div style="text-align:right; margin-bottom:10px;"><button class="btn btn-success btn-sm" onclick="app.exportAnalysisReport()">ğŸ“¥ å¯¼å‡ºæŠ¥è¡¨</button></div>
            <div class="analysis-grid">
                <div class="stat-card"><div>æ•°æ®æ¥æº</div><div class="stat-num" id="stat-source-type" style="font-size:0.9rem; margin-top:5px; color:#64748b">-</div></div>
                <div class="stat-card"><div>åŒºé—´æ€»æ”¯å‡º</div><div class="stat-num" id="stat-total-amount" style="font-size:1.4rem; font-weight:bold; color:var(--primary)">Â¥0.00</div></div>
            </div>
            <div class="charts-wrapper"><div id="chart-l1" class="chart-card"></div><div id="chart-l2" class="chart-card"></div><div id="chart-budget" class="chart-card" style="display:none"></div><div id="chart-project" class="chart-card" style="display:none"></div></div>
            <div style="margin-top: 30px; border-top: 1px dashed var(--border); padding-top: 20px;">
                <h3 style="color:var(--text-sub); text-align:center; margin-bottom:20px;">â¬‡ï¸ è¯¦ç»†æ’è¡Œ (Top N) â¬‡ï¸</h3>
                <div class="ranking-container">
                    <div class="ranking-card"><h4 style="color:var(--primary)">ä¸€çº§åˆ†ç±»</h4><table id="rank-l1-table"><thead><tr><th>åˆ†ç±»</th><th>é‡‘é¢</th><th>å æ¯”</th></tr></thead><tbody></tbody></table></div>
                    <div class="ranking-card"><h4 style="color:var(--purple)">äºŒçº§åˆ†ç±»</h4><table id="rank-l2-table"><thead><tr><th>åˆ†ç±»</th><th>é‡‘é¢</th><th>å æ¯”</th></tr></thead><tbody></tbody></table></div>
                    <div class="ranking-card" id="rank-budget-box" style="display:none"><h4 style="color:var(--primary)">é¢„ç®—è®¡åˆ’</h4><table id="rank-budget-table"><thead><tr><th>è®¡åˆ’åç§°</th><th>æ€»æ”¯å‡º</th><th>å æ¯”</th></tr></thead><tbody></tbody></table></div>
                    <div class="ranking-card" id="rank-project-box" style="display:none"><h4 style="color:var(--purple)">å¤§é¢æ”¯å‡º</h4><table id="rank-project-table"><thead><tr><th>é¡¹ç›®åç§°</th><th>æ€»æ”¯å‡º</th><th>å æ¯”</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼¹çª—ç»„ä»¶ (ä¿æŒä¸å˜) -->
<div id="toast-container"></div>
<div id="confirm-modal" class="modal-overlay"><div class="modal"><h3>ç¡®è®¤æ“ä½œ</h3><p id="confirm-msg" style="color:var(--text-sub);margin-bottom:20px;">...</p><div class="modal-actions"><button class="btn btn-outline" onclick="app.closeModal('confirm-modal')">å–æ¶ˆ</button><button class="btn btn-primary" id="confirm-btn-yes">ç¡®å®š</button></div></div></div>
<div id="note-modal" class="modal-overlay"><div class="modal"><div style="display:flex;justify-content:space-between;margin-bottom:15px"><h3>ğŸ“ å¿«æ·å¤‡æ³¨</h3><button class="btn btn-sm btn-outline" onclick="app.closeModal('note-modal')">âœ•</button></div><div style="display:flex;gap:10px;margin-bottom:20px;padding:15px;background:#f1f5f9;border-radius:8px;"><input type="hidden" id="edit-note-index" value="-1"><input type="text" id="new-note-input" class="form-control" placeholder="è¾“å…¥çŸ­è¯­..."><button class="btn btn-primary" id="save-note-btn" onclick="app.saveQuickNote()">æ·»åŠ </button><button class="btn btn-outline" id="cancel-edit-btn" onclick="app.resetNoteManager()" style="display:none">å–æ¶ˆ</button></div><div id="manage-notes-list" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;padding-right:5px"></div></div></div>
<div id="plan-modal" class="modal-overlay"><div class="modal"><h3 id="plan-modal-title">æ–°å¢è®¡åˆ’</h3><div style="margin-bottom:15px"><label>åç§°</label><input type="text" id="plan-input-name" class="form-control" placeholder="ä¾‹å¦‚ï¼šä¸‰äºšæ—…æ¸¸"></div><div id="plan-input-total-wrapper" style="margin-bottom:15px"><label>æ€»é¢„ç®— (å¯é€‰)</label><input type="number" id="plan-input-total" class="form-control" placeholder="è¾“å…¥é‡‘é¢" step="0.01" inputmode="decimal"></div><div style="margin-bottom:15px"><label>å½’å±å¹´ä»½</label><input type="number" id="plan-input-year" class="form-control" placeholder="2025" inputmode="numeric"></div><div class="modal-actions"><button class="btn btn-outline" onclick="app.closeModal('plan-modal')">å–æ¶ˆ</button><button class="btn btn-primary" id="plan-btn-save">ä¿å­˜</button></div></div></div>
<div id="category-modal" class="modal-overlay"></div>
<div id="chart-view-modal" class="modal-overlay">
    <div class="modal" style="width: 800px; max-width: 95%;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <h3 style="margin:0">ğŸ“Š æ”¶æ”¯ç»Ÿè®¡å›¾</h3>
            <button class="btn btn-sm btn-outline" onclick="app.closeModal('chart-view-modal')">âœ•</button>
        </div>
        <div id="chart-view-container" style="width: 100%; height: 350px;"></div>
        <div class="modal-actions" style="justify-content: center; margin-top: 15px;">
            <button class="btn btn-primary" onclick="app.saveCurrentChart()">ğŸ“¥ ä¿å­˜å›¾ç‰‡</button>
        </div>
    </div>
</div>

<script>
    const App = {
        data: {
            categories: JSON.parse(localStorage.getItem('categories')) || [{ l1: 'é¤é¥®', l2: ['æ—©é¤', 'åˆé¤', 'æ™šé¤'] }, { l1: 'äº¤é€š', l2: ['åœ°é“', 'å…¬äº¤', 'æ‰“è½¦'] }, { l1: 'è´­ç‰©', l2: ['æ—¥ç”¨', 'æœé¥°'] }],
            records: JSON.parse(localStorage.getItem('records')) || {},
            // ç¡®ä¿ plans é»˜è®¤ collapsed: true
            plans: (JSON.parse(localStorage.getItem('plans')) || []).map(p => ({ ...p, collapsed: p.collapsed ?? true, year: p.year || (p.id ? new Date(p.id).getFullYear() : 9999), totalBudget: p.totalBudget||0, items: p.items || [] })),
            quickNotes: JSON.parse(localStorage.getItem('quickNotes')) || ['æ—©é¥­', 'åˆé¥­', 'æ™šé¥­', 'æ‰“è½¦', 'è¶…å¸‚', 'å¥¶èŒ¶', 'æ°´æœ', 'é›¶é£Ÿ'],
            specialItems: JSON.parse(localStorage.getItem('specialItems')) || [], 
            editingId: null, currentAnalysisData: null, lastAnalysisSource: 'local', lastFiles: null, currentChartInstance: null,
            daState: { mode: 'timeline', page: 1, pageSize: 10, filteredList: [] },
            budgetPageState: { page: 1, pageSize: 5 },
            projectPageState: { page: 1, pageSize: 5 },
            specialPageStates: {} 
        },
        init() {
            const now = new Date(); const y = now.getFullYear(); const m = String(now.getMonth() + 1).padStart(2, '0'); const d = String(now.getDate()).padStart(2, '0');
            const today = `${y}-${m}-${d}`;
            document.getElementById('daily-date').value = today;
            document.getElementById('special-date').value = today; 
            this.renderCategorySelects(); this.renderDailyCategoryOptions(); this.loadDailyRecords(); this.renderBudgets(); this.renderProjects(); this.renderNoteDropdown(); this.renderSpecialPage();
            document.addEventListener('click', (e) => { const d=document.getElementById('note-dropdown'); if(d.classList.contains('show')&&!d.contains(e.target)) d.classList.remove('show'); });
            window.addEventListener('resize', () => { this.resizeCharts(); });
        },
        saveData() {
            localStorage.setItem('categories', JSON.stringify(this.data.categories)); localStorage.setItem('records', JSON.stringify(this.data.records));
            localStorage.setItem('plans', JSON.stringify(this.data.plans)); localStorage.setItem('quickNotes', JSON.stringify(this.data.quickNotes));
            localStorage.setItem('specialItems', JSON.stringify(this.data.specialItems)); 
        },
        // --- åŠŸèƒ½å‡½æ•° ---
        backupData() { const data = { version: '1.0', exportDate: new Date().toISOString(), records: this.data.records, categories: this.data.categories, plans: this.data.plans, quickNotes: this.data.quickNotes, specialItems: this.data.specialItems }; this.downloadJSON(data, `è®°è´¦æ•´æœºæ•°æ®_${new Date().toISOString().split('T')[0]}.json`); this.toast('æ•°æ®å¤‡ä»½å·²å¼€å§‹ä¸‹è½½', 'success'); },
        restoreData(input) {
            const file = input.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = (e) => {
                try { const imported = JSON.parse(e.target.result); if (confirm(`å³å°†è¦†ç›–ç°æœ‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šå¯¼å…¥å—ï¼Ÿ\næ–‡ä»¶æ—¥æœŸ: ${imported.exportDate || 'æœªçŸ¥'}`)) { if (imported.records) this.data.records = imported.records; if (imported.categories) this.data.categories = imported.categories; if (imported.plans) this.data.plans = imported.plans; if (imported.quickNotes) this.data.quickNotes = imported.quickNotes; if (imported.specialItems) this.data.specialItems = imported.specialItems; this.saveData(); this.init(); this.toast('æ•°æ®æ¢å¤æˆåŠŸï¼', 'success'); } } catch(err) { this.toast('æ–‡ä»¶è§£æå¤±è´¥', 'error'); } input.value = '';
            }; reader.readAsText(file);
        },
        clearSpecialItems() {
            this.confirm('âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰ç‰¹åˆ«æ”¯å‡ºå—ï¼Ÿ\n1. åˆ é™¤æ‰€æœ‰ç‹¬ç«‹è®°å½•\n2. å–æ¶ˆæ‰€æœ‰æ—¥å¸¸è´¦å•çš„â€œç‰¹åˆ«å…³æ³¨â€æ ‡è®°', () => {
                this.data.specialItems = []; Object.values(this.data.records).forEach(list => list.forEach(r => r.isSpecial = false));
                this.saveData(); this.renderSpecialPage(); this.toast('ç‰¹åˆ«æ”¯å‡ºåˆ—è¡¨å·²æ¸…ç©º');
            });
        },
        clearPlans(type) {
            const typeName = type === 'budget' ? 'é¢„ç®—è®¡åˆ’' : 'å¤§é¢æ”¯å‡º';
            this.confirm(`âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰â€œ${typeName}â€å—ï¼Ÿ\næ³¨æ„ï¼šç›¸å…³çš„æ—¥å¸¸å…¥è´¦è®°å½•ä¹Ÿä¼šè¢«ä¸€å¹¶åˆ é™¤ï¼`, () => {
                const targetPlans = this.data.plans.filter(p => (!p.type && type === 'budget') || p.type === type);
                targetPlans.forEach(p => { p.items.forEach(i => { if(i.isSynced) this.removeRecordGlobal(i.linkedRecordId); }); });
                this.data.plans = this.data.plans.filter(p => !((!p.type && type === 'budget') || p.type === type));
                this.saveData(); this.refreshPlanUI(type); this.loadDailyRecords(); this.toast(`${typeName}å·²æ¸…ç©º`);
            });
        },
        exportSpecial() {
            let list = []; Object.entries(this.data.records).forEach(([date, records]) => { records.forEach(r => { if(r.isSpecial) { let name = r.l1; if(r.l2) name += ` - ${r.l2}`; list.push({æ—¥æœŸ: date, åç§°: name, å¤‡æ³¨: r.note, é‡‘é¢: r.amount, æ¥æº: 'æ—¥å¸¸åŒæ­¥'}); } }); });
            this.data.specialItems.forEach(i => { list.push({æ—¥æœŸ: i.date, åç§°: i.name, å¤‡æ³¨: i.note, é‡‘é¢: i.amount, æ¥æº: 'ç‹¬ç«‹è®°å½•'}); });
            if(!list.length) return this.toast('æ— æ•°æ®å¯å¯¼å‡º', 'error'); list.sort((a,b) => new Date(b.æ—¥æœŸ) - new Date(a.æ—¥æœŸ));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(list), "ç‰¹åˆ«æ”¯å‡º"); XLSX.writeFile(wb, `ç‰¹åˆ«æ”¯å‡º_${new Date().toISOString().split('T')[0]}.xlsx`); this.toast('å¯¼å‡ºæˆåŠŸ', 'success');
        },
        exportPlans(type) {
            const typeName = type === 'budget' ? 'é¢„ç®—è®¡åˆ’' : 'å¤§é¢æ”¯å‡º'; const list = this.data.plans.filter(p => (!p.type && type==='budget') || p.type === type); if(!list.length) return this.toast('æ— æ•°æ®å¯å¯¼å‡º', 'error');
            let exportData = []; list.forEach(p => { if(!p.items || !p.items.length) { exportData.push({ è®¡åˆ’åç§°: p.name, å¹´ä»½: p.year, [type==='budget'?'æ€»é¢„ç®—':'é¢„ä¼°æ€»é¢']: p.totalBudget || 0, æ˜ç»†åç§°: '-', é¢„ç®—: 0, å®é™…: 0, äººæ•°: '-', å¤‡æ³¨: '-', æ—¥æœŸ: '-' }); } else { p.items.forEach(i => { let row = { è®¡åˆ’åç§°: p.name, å¹´ä»½: p.year, [type==='budget'?'æ€»é¢„ç®—':'é¢„ä¼°æ€»é¢']: p.totalBudget || 0, æ˜ç»†åç§°: i.name, å®é™…æ”¯å‡º: i.actual || 0, å¤‡æ³¨: i.remark || '', æ—¥æœŸ: i.date }; if(type === 'budget') { row['æ˜ç»†é¢„ç®—'] = i.budget || 0; row['äººæ•°'] = i.people || 1; } exportData.push(row); }); } });
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportData), typeName); XLSX.writeFile(wb, `${typeName}_${new Date().toISOString().split('T')[0]}.xlsx`); this.toast('å¯¼å‡ºæˆåŠŸ', 'success');
        },
        exportCategoriesConfig() { this.downloadJSON(this.data.categories, `åˆ†ç±»é…ç½®_${new Date().toISOString().split('T')[0]}.json`); this.toast('åˆ†ç±»é…ç½®å·²å¯¼å‡º', 'success'); },
        importCategoriesConfig() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const imported = JSON.parse(ev.target.result); if (Array.isArray(imported)) { if(confirm("ç¡®å®šè¦†ç›–å½“å‰çš„åˆ†ç±»é…ç½®å—ï¼Ÿ")) { this.data.categories = imported; this.saveData(); this.renderCategorySelects(); this.openCategoryModal(); this.toast('åˆ†ç±»é…ç½®å·²æ›´æ–°', 'success'); } } else { this.toast('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error'); } } catch(err) { this.toast('è§£æå¤±è´¥', 'error'); } }; reader.readAsText(file); }; input.click(); },
        downloadJSON(data, filename) { const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); },
        toast(msg, type='info') { const c=document.getElementById('toast-container'); const d=document.createElement('div'); d.className='toast'; d.textContent=msg; if(type==='error')d.style.background='#ef4444'; if(type==='success')d.style.background='#10b981'; c.appendChild(d); requestAnimationFrame(()=>d.classList.add('show')); setTimeout(()=>{d.classList.remove('show');setTimeout(()=>d.remove(),300)},3000); },
        confirm(msg, onYes) { document.getElementById('confirm-msg').innerText=msg; document.getElementById('confirm-modal').style.display='flex'; document.getElementById('confirm-btn-yes').onclick=()=>{onYes();this.closeModal('confirm-modal')}; },
        closeModal(id) { document.getElementById(id).style.display='none'; },
        switchTab(tabName) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); const tabs = ['daily', 'daily-analysis', 'special', 'budgets', 'projects', 'analysis']; document.querySelectorAll('.tab')[tabs.indexOf(tabName)].classList.add('active'); document.getElementById('tab-'+tabName).classList.add('active'); if(tabName==='daily-analysis') this.renderDailyAnalysis(); if(tabName==='special') this.renderSpecialPage(); if(tabName==='analysis') { if(this.data.lastAnalysisSource === 'local') this.analyzeLocalData(); } window.scrollTo(0,0); },
        removeRecordGlobal(rid) { for (const d in this.data.records) { this.data.records[d]=this.data.records[d].filter(r=>r.id!==rid); if(this.data.records[d].length===0)delete this.data.records[d]; } },
        resetPlanItemStatus(lrid) { this.data.plans.forEach(p=>p.items.forEach(i=>{if(i.linkedRecordId===lrid){i.isSynced=false;i.linkedRecordId=null}})); },
        
        // --- æ ¸å¿ƒï¼šè¾“å…¥æ¡†æŠ˜å é€»è¾‘ ---
        toggleInputForm(wrapperId, btn) {
            const wrapper = document.getElementById(wrapperId);
            const isActive = btn.classList.contains('active');
            if(isActive) {
                wrapper.classList.remove('open');
                btn.classList.remove('active');
                btn.querySelector('span').innerText = wrapperId.includes('special') ? '+ è®°ä¸€ç¬” (ç‹¬ç«‹)' : '+ è®°ä¸€ç¬”';
            } else {
                wrapper.classList.add('open');
                btn.classList.add('active');
                btn.querySelector('span').innerText = 'æ”¶èµ·è¾“å…¥æ¡†';
            }
        },

        // --- 1. æ—¥å¸¸è®°è´¦ ---
        renderCategorySelects() { const l1=document.getElementById('daily-l1'); l1.innerHTML=this.data.categories.map(c=>`<option value="${c.l1}">${c.l1}</option>`).join(''); this.updateL2Options(); },
        updateL2Options() { const v=document.getElementById('daily-l1').value, cat=this.data.categories.find(c=>c.l1===v); document.getElementById('daily-l2').innerHTML=cat?cat.l2.map(s=>`<option value="${s}">${s}</option>`).join(''):''; },
        renderNoteDropdown() { const l=document.getElementById('note-dropdown'); l.innerHTML=this.data.quickNotes.length?this.data.quickNotes.map(n=>`<div class="dropdown-item" onclick="app.selectNote('${n}')">${n}</div>`).join(''):`<div style="padding:10px;text-align:center;font-size:0.85rem">æš‚æ— </div>`; },
        toggleNoteDropdown(show) { const l=document.getElementById('note-dropdown'); show?l.classList.add('show'):l.classList.remove('show'); },
        selectNote(t) { document.getElementById('daily-note').value=t; this.toggleNoteDropdown(false); },
        openNoteManager() { document.getElementById('note-modal').style.display='flex'; this.resetNoteManager(); this.renderManageNotes(); },
        renderManageNotes() { const container = document.getElementById('manage-notes-list'); container.innerHTML = this.data.quickNotes.map((n, i) => `<div class="manage-tag-item"><span style="font-weight:500;">${n}</span><div class="manage-actions"><span class="drag-handle">â‹®â‹®</span><span class="icon-btn" style="color:var(--primary)" onclick="app.prepareEditNote(${i})">âœï¸</span><span class="icon-btn" style="color:var(--danger)" onclick="app.deleteQuickNote(${i})">ğŸ—‘ï¸</span></div></div>`).join(''); new Sortable(container, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: (evt) => { const item = this.data.quickNotes.splice(evt.oldIndex, 1)[0]; this.data.quickNotes.splice(evt.newIndex, 0, item); this.saveData(); this.renderNoteDropdown(); } }); },
        prepareEditNote(i) { document.getElementById('new-note-input').value=this.data.quickNotes[i]; document.getElementById('edit-note-index').value=i; document.getElementById('save-note-btn').innerText="ä¿å­˜ä¿®æ”¹"; document.getElementById('save-note-btn').className="btn btn-purple"; document.getElementById('cancel-edit-btn').style.display="inline-block"; },
        saveQuickNote() { const v=document.getElementById('new-note-input').value.trim(), i=parseInt(document.getElementById('edit-note-index').value); if(!v) return this.toast('ä¸èƒ½ä¸ºç©º','error'); if(i===-1) this.data.quickNotes.push(v); else this.data.quickNotes[i]=v; this.saveData(); this.renderNoteDropdown(); this.renderManageNotes(); this.resetNoteManager(); },
        deleteQuickNote(i) { this.confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ', ()=>{this.data.quickNotes.splice(i,1);this.saveData();this.renderNoteDropdown();this.renderManageNotes();this.resetNoteManager()}); },
        resetNoteManager() { document.getElementById('new-note-input').value=''; document.getElementById('edit-note-index').value='-1'; document.getElementById('save-note-btn').innerText="æ·»åŠ "; document.getElementById('save-note-btn').className="btn btn-primary"; document.getElementById('cancel-edit-btn').style.display="none"; },
        
        loadDailyRecords() { 
            const d=document.getElementById('daily-date').value, list=this.data.records[d]||[]; 
            document.getElementById('daily-tbody').innerHTML=list.map(r=> {
                const starIcon = r.isSpecial ? 'ğŸŒŸ' : 'â˜†'; 
                const starClass = r.isSpecial ? 'btn-star active' : 'btn-star'; 
                const sourceBadge = r.source==='plan'?'<span style="font-size:0.8em;background:#e0f2fe;color:#0369a1;padding:2px 6px;border-radius:4px;">è®¡åˆ’</span>':'';
                
                return `<tr>
                    <td>${r.l1}</td>
                    <td>${r.l2}</td>
                    <td>${r.note} ${sourceBadge}</td>
                    <td class="amount-cell">Â¥${parseFloat(r.amount).toFixed(2)}</td>
                    <!-- å…³é”®ä¿®æ”¹åœ¨è¿™é‡Œï¼šå¢åŠ äº† align-items: center -->
                    <td style="display:flex; gap:5px; align-items: center;">
                        <button class="${starClass}" onclick="app.toggleRecordSpecial(${r.id}, '${d}')">${starIcon}</button>
                        ${r.source==='plan'
                            // å…³é”®ä¿®æ”¹åœ¨è¿™é‡Œï¼šå»æ‰äº† padding-top
                            ? '<span style="color:#94a3b8;font-size:0.8rem;">å…³è”</span>'
                            : `<button class="btn btn-outline btn-sm" onclick="app.editRecord(${r.id})">âœï¸</button><button class="btn btn-danger btn-sm" onclick="app.deleteRecord(${r.id})">ğŸ—‘ï¸</button>`
                        }
                    </td>
                </tr>`;
            }).join(''); 
            document.getElementById('daily-total').innerText='Â¥'+list.reduce((s,r)=>s+parseFloat(r.amount),0).toFixed(2); 
            this.resetForm(); 
        },

        addOrUpdateRecord() { 
            const d=document.getElementById('daily-date').value, l1=document.getElementById('daily-l1').value, l2=document.getElementById('daily-l2').value, n=document.getElementById('daily-note').value, a=parseFloat(document.getElementById('daily-amount').value); 
            if(!l1||isNaN(a)||a<=0) return this.toast('é‡‘é¢æ— æ•ˆ','error'); if(!this.data.records[d]) this.data.records[d]=[]; 
            if(this.data.editingId) { const idx=this.data.records[d].findIndex(r=>r.id===this.data.editingId); if(idx!==-1) { const oldSpecial = this.data.records[d][idx].isSpecial; this.data.records[d][idx]={...this.data.records[d][idx], l1, l2, note:n, amount:a, isSpecial: oldSpecial}; } } else { this.data.records[d].push({id:Date.now(), l1, l2, note:n, amount:a, source:'daily', isSpecial: false}); }
            this.saveData(); this.loadDailyRecords(); this.toast('å·²ä¿å­˜','success'); 
            // è®°è´¦åè‡ªåŠ¨æ”¶èµ·
            if(window.innerWidth < 768) { 
               const btn = document.getElementById('daily-input-toggle');
               if(btn && btn.classList.contains('active')) this.toggleInputForm('daily-input-wrapper', btn);
            }
        },

        toggleRecordSpecial(id, dateFromRow = null) { const d = dateFromRow || document.getElementById('daily-date').value; const record = this.data.records[d]?.find(r => r.id === id); if(record) { record.isSpecial = !record.isSpecial; this.saveData(); this.loadDailyRecords(); if(document.getElementById('tab-special').classList.contains('active')) { this.renderSpecialPage(); } } },
        editRecord(id) { 
            const d=document.getElementById('daily-date').value, r=this.data.records[d].find(x=>x.id===id); if(!r||r.source==='plan')return; 
            document.getElementById('daily-l1').value=r.l1; this.updateL2Options(); document.getElementById('daily-l2').value=r.l2; document.getElementById('daily-note').value=r.note; document.getElementById('daily-amount').value=r.amount; this.data.editingId=id; document.getElementById('daily-submit-btn').innerText='ä¿å­˜ä¿®æ”¹';
            const btn = document.getElementById('daily-input-toggle');
            if(btn && !btn.classList.contains('active')) this.toggleInputForm('daily-input-wrapper', btn);
            document.getElementById('daily-amount').focus(); 
        },
        deleteRecord(id) { const d=document.getElementById('daily-date').value; this.resetPlanItemStatus(id); this.data.records[d]=this.data.records[d].filter(r=>r.id!==id); this.saveData(); this.loadDailyRecords(); this.toast('å·²åˆ é™¤'); },
        resetForm() { document.getElementById('daily-note').value=''; document.getElementById('daily-amount').value=''; this.data.editingId=null; document.getElementById('daily-submit-btn').innerText='è®°ä¸€ç¬”'; },
        exportDaily() { const d=document.getElementById('daily-date').value, list=this.data.records[d]; if(!list)return this.toast('æ— æ•°æ®','error'); const wb=XLSX.utils.book_new(), data=list.map(i=>({"æ—¥æœŸ":d,"ä¸€çº§åˆ†ç±»":i.l1,"äºŒçº§åˆ†ç±»":i.l2,"å¤‡æ³¨":i.note,"é‡‘é¢":i.amount,"æ¥æº":i.source==='plan'?'è®¡åˆ’':'æ—¥å¸¸',"ç‰¹åˆ«å…³æ³¨":i.isSpecial?'æ˜¯':'å¦'})); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data),"Sheet1"); XLSX.writeFile(wb, `è®°è´¦_${d}.xlsx`); this.toast('å¯¼å‡ºæˆåŠŸ','success'); },
        clearDayData() { const d=document.getElementById('daily-date').value; if(!this.data.records[d])return this.toast('æ— æ•°æ®','error'); this.confirm('ç¡®è®¤æ¸…ç©ºï¼Ÿ', ()=>{this.data.records[d].forEach(r=>{if(r.source==='plan')this.resetPlanItemStatus(r.id)});delete this.data.records[d];this.saveData();this.init();this.toast('å·²æ¸…ç©º');}); },

        // --- 1.5. æ—¥å¸¸å½’çº³åˆ†æ (ä¿®å¤ï¼šæŠ˜å /å±•å¼€é—®é¢˜) ---
        renderDailyCategoryOptions() { const l1 = document.getElementById('da-l1'); if(!l1) return; l1.innerHTML = '<option value="">å…¨éƒ¨</option>' + this.data.categories.map(c => `<option value="${c.l1}">${c.l1}</option>`).join(''); this.updateDaL2Options(); },
        updateDaL2Options() { const v = document.getElementById('da-l1').value; const l2 = document.getElementById('da-l2'); if(!v) l2.innerHTML = '<option value="">å…¨éƒ¨</option>'; else { const cat = this.data.categories.find(c => c.l1 === v); l2.innerHTML = '<option value="">å…¨éƒ¨</option>' + (cat ? cat.l2.map(s => `<option value="${s}">${s}</option>`).join('') : ''); } },
        changeAnalysisMode(mode) { this.data.daState.mode = mode; document.getElementById('mode-timeline').className = mode === 'timeline' ? 'mode-btn active' : 'mode-btn'; document.getElementById('mode-list').className = mode === 'list' ? 'mode-btn active' : 'mode-btn'; document.getElementById('daily-analysis-timeline').style.display = mode === 'timeline' ? 'block' : 'none'; document.getElementById('daily-analysis-list-view').style.display = mode === 'list' ? 'block' : 'none'; document.getElementById('da-category-filters').style.display = mode === 'list' ? 'flex' : 'none'; this.renderDailyAnalysis(); },
        handleAnalysisDateChange() { if(this.data.daState.mode === 'timeline') this.renderDailyAnalysisTimeline(); else this.searchDailyDetails(1); },
        renderDailyAnalysis() { if (this.data.daState.mode === 'timeline') this.renderDailyAnalysisTimeline(); else this.searchDailyDetails(1); },
        renderDailyAnalysisTimeline() {
            const container = document.getElementById('daily-analysis-timeline'); const startStr = document.getElementById('da-start').value, endStr = document.getElementById('da-end').value, startDate = startStr?new Date(startStr):null, endDate = endStr?new Date(endStr):null; const tree = {}; let totalAmount = 0;
            Object.entries(this.data.records).forEach(([dateStr, list]) => { const d = new Date(dateStr); if (startDate && d < startDate) return; if (endDate && d > endDate) return; const dayTotal = list.reduce((s, r) => s + parseFloat(r.amount), 0); if (dayTotal === 0) return; totalAmount += dayTotal; const [year, month, day] = dateStr.split('-'); if (!tree[year]) tree[year] = { total: 0, months: {} }; tree[year].total += dayTotal; if (!tree[year].months[month]) tree[year].months[month] = { total: 0, days: {} }; tree[year].months[month].total += dayTotal; tree[year].months[month].days[dateStr] = dayTotal; });
            document.getElementById('da-total-amount').innerText = 'Â¥' + totalAmount.toFixed(2); container.innerHTML = totalAmount===0 ? '<div style="padding:20px;text-align:center;color:#999">è¯¥æ—¶é—´æ®µæ— è®°å½•</div>' : '';
            Object.keys(tree).sort((a,b)=>b-a).forEach(year => {
                const yData = tree[year]; const card = document.createElement('div'); card.className = 'plan-card collapsed'; 
                // ä¿®å¤ï¼šå¹´ä»½æ ä½¿ç”¨ row-only å¼ºåˆ¶åŒè¡Œæ˜¾ç¤º
                card.innerHTML = `
                    <div class="plan-header row-only" onclick="this.parentElement.classList.toggle('collapsed')">
                        <div class="plan-header-top">
                            <div class="header-left">
                                <span class="toggle-icon">â–¼</span>
                                <strong style="font-size:1.1rem; color:var(--text-main)">${year}å¹´</strong>
                            </div>
                            <div class="header-right" style="font-size:0.95rem; font-weight:bold; color:var(--primary)">Â¥${yData.total.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="plan-items"></div>`; 
                const ic = card.querySelector('.plan-items');
                Object.keys(yData.months).sort((a,b)=>b-a).forEach(month => { 
                    const mData = yData.months[month]; 
                    const mGroup = document.createElement('div'); 
                    // ä¿®å¤ï¼šé»˜è®¤æ·»åŠ  collapsed ç±»ï¼Œä½¿æœˆä»½é»˜è®¤æŠ˜å 
                    mGroup.className = 'analysis-month-group collapsed'; 
                    mGroup.innerHTML = `
                        <div class="analysis-month-row" onclick="this.parentElement.classList.toggle('collapsed')">
                            <div class="row-content">
                                <div style="display:flex; align-items:center">
                                    <span class="toggle-icon" style="font-size:0.7rem; margin-right:5px">â–¼</span>
                                    <span>${month}æœˆ</span>
                                </div>
                                <span>Â¥${mData.total.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="analysis-days-container"></div>`; 
                    const dc = mGroup.querySelector('.analysis-days-container'); 
                    Object.keys(mData.days).sort((a,b)=>new Date(b)-new Date(a)).forEach(day => { 
                        dc.innerHTML += `<div class="analysis-day-row"><span>${day}</span><span>Â¥${mData.days[day].toFixed(2)}</span></div>`; 
                    }); 
                    ic.appendChild(mGroup); 
                }); 
                container.appendChild(card);
            });
        },
        searchDailyDetails(page = 1) {
            const startStr = document.getElementById('da-start').value; const endStr = document.getElementById('da-end').value; const l1Filter = document.getElementById('da-l1').value; const l2Filter = document.getElementById('da-l2').value; const start = startStr ? new Date(startStr) : null; const end = endStr ? new Date(endStr) : null; let allRows = [];
            Object.entries(this.data.records).forEach(([dateStr, list]) => { const d = new Date(dateStr); if (start && d < start) return; if (end && d > end) return; list.forEach(r => { if (l1Filter && r.l1 !== l1Filter) return; if (l2Filter && r.l2 !== l2Filter) return; allRows.push({ ...r, date: dateStr }); }); });
            allRows.sort((a, b) => new Date(b.date) - new Date(a.date)); const total = allRows.reduce((s, r) => s + parseFloat(r.amount), 0); document.getElementById('da-total-amount').innerText = 'Â¥' + total.toFixed(2); this.data.daState.filteredList = allRows; this.data.daState.page = page; this.renderDaTable();
        },
        renderDaTable() {
            const { filteredList, page, pageSize } = this.data.daState; const tbody = document.getElementById('da-list-tbody'); const pagination = document.getElementById('da-pagination'); if (filteredList.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#999">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®°å½•</td></tr>'; pagination.style.display = 'none'; return; }
            const totalPages = Math.ceil(filteredList.length / pageSize); const startIdx = (page - 1) * pageSize; const pagedData = filteredList.slice(startIdx, startIdx + pageSize);
            tbody.innerHTML = pagedData.map(r => `<tr><td>${r.date}</td><td>${r.l1}</td><td>${r.l2 || '-'}</td><td>${r.note || ''}</td><td class="amount-cell">Â¥${parseFloat(r.amount).toFixed(2)}</td></tr>`).join('');
            pagination.style.display = 'flex'; document.getElementById('da-page-info').innerText = `ç¬¬ ${page} / ${totalPages} é¡µ (å…± ${filteredList.length} æ¡)`; const btns = pagination.querySelectorAll('button'); btns[0].disabled = page <= 1; btns[1].disabled = page >= totalPages;
        },
        changeDaPage(delta) { const { page, pageSize, filteredList } = this.data.daState; const totalPages = Math.ceil(filteredList.length / pageSize); const newPage = page + delta; if (newPage >= 1 && newPage <= totalPages) { this.data.daState.page = newPage; this.renderDaTable(); } },
        exportDailyAnalysisList() {
            const list = this.data.daState.filteredList; if (!list.length) return this.toast('æ— æ•°æ®å¯å¯¼å‡º', 'error');
            const data = list.map(i => ({"æ—¥æœŸ": i.date, "ä¸€çº§åˆ†ç±»": i.l1, "äºŒçº§åˆ†ç±»": i.l2, "å¤‡æ³¨": i.note, "é‡‘é¢": i.amount}));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "æŸ¥è¯¢ç»“æœ");
            XLSX.writeFile(wb, `æ¶ˆè´¹æŸ¥è¯¢_${new Date().toISOString().split('T')[0]}.xlsx`); this.toast('å¯¼å‡ºæˆåŠŸ', 'success');
        },

        // --- ğŸŒŸ ç‰¹åˆ«æ”¯å‡º ---
        addSpecialItem() {
            const date = document.getElementById('special-date').value; const name = document.getElementById('special-name').value; const note = document.getElementById('special-note').value; const amount = parseFloat(document.getElementById('special-amount').value);
            if(!name || isNaN(amount) || amount <= 0) return this.toast('è¯·è¾“å…¥åç§°å’Œæœ‰æ•ˆé‡‘é¢', 'error');
            this.data.specialItems.push({ id: Date.now(), date, name, note, amount }); this.saveData(); this.renderSpecialPage(); this.toast('å·²æ·»åŠ ç‰¹åˆ«æ”¯å‡º (ç‹¬ç«‹)');
            document.getElementById('special-name').value = ''; document.getElementById('special-note').value = ''; document.getElementById('special-amount').value = '';
            if(window.innerWidth < 768) {
               const btn = document.getElementById('special-input-toggle');
               if(btn && btn.classList.contains('active')) this.toggleInputForm('special-input-wrapper', btn);
            }
        },
        deleteSpecialItem(id) { this.confirm('ç¡®å®šåˆ é™¤æ­¤æ¡ç‰¹åˆ«æ”¯å‡ºï¼Ÿ', () => { this.data.specialItems = this.data.specialItems.filter(i => i.id !== id); this.saveData(); this.renderSpecialPage(); }); },
        renderSpecialPage(pageInput = null) {
            const container = document.getElementById('special-container'); container.innerHTML = ''; let allSpecials = [];
            Object.entries(this.data.records).forEach(([date, list]) => { list.forEach(r => { if(r.isSpecial) { let displayName = r.l1; if(r.l2 && r.l2 !== '') displayName += ` - ${r.l2}`; allSpecials.push({ ...r, date, origin: 'daily', displayName }); } }); });
            this.data.specialItems.forEach(i => allSpecials.push({ ...i, origin: 'special', displayName: i.name }));
            if(allSpecials.length === 0) { container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— ç‰¹åˆ«å…³æ³¨çš„æ”¯å‡º</div>'; return; }
            const groups = {}; allSpecials.forEach(item => { const y = item.date.split('-')[0]; if(!groups[y]) groups[y] = { total: 0, items: [] }; groups[y].total += parseFloat(item.amount); groups[y].items.push(item); });
            Object.keys(groups).sort((a,b)=>b-a).forEach(y => {
                const g = groups[y]; if (!this.data.specialPageStates[y]) this.data.specialPageStates[y] = { page: 1, pageSize: 10 }; const ps = this.data.specialPageStates[y];
                const sortedItems = g.items.sort((a,b)=>new Date(b.date)-new Date(a.date)); const totalCount = sortedItems.length; const totalPages = Math.ceil(totalCount / ps.pageSize);
                if (ps.page > totalPages) ps.page = totalPages; if (ps.page < 1) ps.page = 1;
                const startIdx = (ps.page - 1) * ps.pageSize; const pageItems = sortedItems.slice(startIdx, startIdx + ps.pageSize);
                const card = document.createElement('div'); card.className = 'plan-card collapsed'; 
                let itemsHtml = pageItems.map(i => {
                    const tag = i.origin==='daily' ? '<span class="source-tag source-daily">æ—¥å¸¸åŒæ­¥</span>' : '<span class="source-tag source-special">ç‹¬ç«‹è®°å½•</span>';
                    const delBtn = i.origin==='special' ? `<button class="btn btn-danger btn-sm" onclick="app.deleteSpecialItem(${i.id})">Ã—</button>` : `<button class="btn btn-outline btn-sm" style="color:#f59e0b;border-color:#f59e0b" onclick="app.toggleRecordSpecial(${i.id}, '${i.date}')" title="å–æ¶ˆå…³æ³¨">ğŸŒŸ</button>`;
                    return `<div class="analysis-day-row"><div style="flex:1"><div style="font-weight:500">${i.displayName} ${tag}</div><div style="font-size:0.85rem;color:#94a3b8">${i.date} ${i.note ? '- '+i.note : ''}</div></div><div style="display:flex;align-items:center;gap:10px;"><span style="font-weight:bold;color:var(--special)">Â¥${parseFloat(i.amount).toFixed(2)}</span>${delBtn}</div></div>`;
                }).join('');
                const paginationHtml = totalCount > 0 ? `<div class="card-pagination" style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; padding-top: 15px; border-top: 1px dashed #e2e8f0; margin-top: 10px;"><select class="page-size-select" style="padding: 4px; border-radius: 4px; border: 1px solid var(--border);" onchange="app.changeSpecialYearPageSize('${y}', this.value)" onclick="event.stopPropagation()"><option value="10" ${ps.pageSize==10?'selected':''}>10æ¡</option><option value="20" ${ps.pageSize==20?'selected':''}>20æ¡</option><option value="50" ${ps.pageSize==50?'selected':''}>50æ¡</option></select><button class="card-page-btn" style="padding: 2px 8px; font-size: 0.8rem; border: 1px solid #cbd5e1; background: white; border-radius: 4px;" onclick="event.stopPropagation();app.changeSpecialYearPage('${y}', -1)" ${ps.page<=1?'disabled':''}>&lt;</button><span class="card-page-info" style="font-size: 0.8rem; color: #64748b;">${ps.page}/${totalPages}</span><button class="card-page-btn" style="padding: 2px 8px; font-size: 0.8rem; border: 1px solid #cbd5e1; background: white; border-radius: 4px;" onclick="event.stopPropagation();app.changeSpecialYearPage('${y}', 1)" ${ps.page>=totalPages?'disabled':''}>&gt;</button></div>` : '';
                
                // ç‰¹åˆ«æ”¯å‡ºå¤´éƒ¨ç»“æ„é‡å†™
                card.innerHTML = `
                    <div class="plan-header row-only" onclick="this.parentElement.classList.toggle('collapsed')">
                        <div class="plan-header-top">
                            <div class="header-left">
                                <span class="toggle-icon">â–¼</span>
                                <strong style="font-size:1.1rem; color:var(--text-main)">${y}å¹´</strong>
                            </div>
                            <div class="header-right" style="font-size:0.95rem; font-weight:bold; color:var(--special)">Â¥${g.total.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="plan-items">${itemsHtml}${paginationHtml}</div>`; 
                container.appendChild(card);
            });
        },
        changeSpecialYearPage(year, delta) { if (!this.data.specialPageStates[year]) return; this.data.specialPageStates[year].page += delta; this.renderSpecialPage(); setTimeout(() => { const headers = document.querySelectorAll('#special-container .plan-header'); headers.forEach(h => { if(h.innerText.includes(year)) h.parentElement.classList.remove('collapsed'); }); }, 50); },
        changeSpecialYearPageSize(year, size) { if (!this.data.specialPageStates[year]) return; this.data.specialPageStates[year].pageSize = parseInt(size); this.data.specialPageStates[year].page = 1; this.renderSpecialPage(); setTimeout(() => { const headers = document.querySelectorAll('#special-container .plan-header'); headers.forEach(h => { if(h.innerText.includes(year)) h.parentElement.classList.remove('collapsed'); }); }, 50); },

        // --- 2. è®¡åˆ’ä¸é¡¹ç›® ---
        openPlanModal(mode, typeOrId) {
            const modal = document.getElementById('plan-modal'), title = document.getElementById('plan-modal-title'), nameInput = document.getElementById('plan-input-name'), totalInput = document.getElementById('plan-input-total'), yearInput = document.getElementById('plan-input-year'), saveBtn = document.getElementById('plan-btn-save');
            let currentType = typeOrId; if (mode === 'edit') { const p = this.data.plans.find(x => x.id === typeOrId); currentType = p.type; }
            document.getElementById('plan-input-total-wrapper').style.display = (currentType === 'project') ? 'none' : 'block';
            modal.style.display = 'flex';
            saveBtn.onclick = () => {
                const name = nameInput.value, year = parseInt(yearInput.value) || new Date().getFullYear(), total = parseFloat(totalInput.value) || 0;
                if(!name) return this.toast('è¯·è¾“å…¥åç§°', 'error');
                if(mode==='add') this.data.plans.unshift({ id: Date.now(), name, type: typeOrId, year, totalBudget: total, collapsed: true, items: [] });
                else { const p = this.data.plans.find(p=>p.id===typeOrId); p.name=name; p.year=year; p.totalBudget=total; }
                this.saveData(); this.refreshPlanUI(mode==='add'?typeOrId:this.data.plans.find(p=>p.id===typeOrId).type); this.closeModal('plan-modal');
            };
            if(mode==='add') { title.innerText = typeOrId==='budget'?'æ–°å¢é¢„ç®—è®¡åˆ’':'æ–°å¢å¤§é¢æ”¯å‡º'; nameInput.value=''; totalInput.value=''; yearInput.value=new Date().getFullYear(); }
            else { const p=this.data.plans.find(x=>x.id===typeOrId); title.innerText='ç¼–è¾‘'; nameInput.value=p.name; totalInput.value=p.totalBudget||''; yearInput.value=p.year; }
        },
        deletePlan(id) { this.confirm('åˆ é™¤æ­¤é¡¹ç›®ï¼Ÿ', () => { const p=this.data.plans.find(x=>x.id===id); p.items.forEach(i=>{if(i.isSynced)this.removeRecordGlobal(i.linkedRecordId)}); this.data.plans=this.data.plans.filter(x=>x.id!==id); this.saveData(); this.refreshPlanUI(p.type); this.loadDailyRecords(); }); },
        togglePlan(id) { const p=this.data.plans.find(x=>x.id===id); p.collapsed=!p.collapsed; this.saveData(); this.refreshPlanUI(p.type); },
        addPlanItem(pid) { const p=this.data.plans.find(x=>x.id===pid); p.collapsed=false; if(!p.items)p.items=[]; p.items.push({id:Date.now(), name:'', budget:0, actual:0, people:1, remark:'', date:new Date().toISOString().split('T')[0], isSynced:false}); this.saveData(); this.refreshPlanUI(p.type); },
        updatePlanItem(pid, iid, field, val) { const item=this.data.plans.find(p=>p.id===pid).items.find(i=>i.id===iid); item[field]=val; this.saveData(); },
        deletePlanItem(pid, iid) { const p=this.data.plans.find(x=>x.id===pid), item=p.items.find(i=>i.id===iid); if(item.isSynced)this.removeRecordGlobal(item.linkedRecordId); p.items=p.items.filter(i=>i.id!==iid); this.saveData(); this.refreshPlanUI(p.type); this.loadDailyRecords(); },
        syncPlanItem(pid, iid) {
            const p = this.data.plans.find(x => x.id === pid), item = p.items.find(i => i.id === iid);
            if(!item.name || !item.actual || parseFloat(item.actual) <= 0) return this.toast('ä¿¡æ¯ä¸å®Œæ•´', 'error');
            const rid = Date.now();
            let noteText = p.type === 'budget' ? 'è®¡åˆ’' : 'å¤§é¢æ”¯å‡º'; if (item.remark && item.remark.trim() !== "") noteText += ` (${item.remark})`;
            let people = 1; if(p.type === 'budget') people = parseInt(item.people) || 1; const finalAmount = parseFloat(item.actual) / people;
            if(people > 1) noteText += ` (AA: ${people}äºº)`;
            if(!this.data.records[item.date]) this.data.records[item.date] = [];
            this.data.records[item.date].push({ id: rid, l1: p.name, l2: item.name, note: noteText, amount: finalAmount, source: 'plan', linkedPlanId: pid, linkedItemId: iid });
            item.isSynced = true; item.linkedRecordId = rid;
            this.saveData(); this.refreshPlanUI(p.type); if(item.date===document.getElementById('daily-date').value) this.loadDailyRecords();
            this.toast('å·²å…¥è´¦' + (people > 1 ? ` (äººå‡ Â¥${finalAmount.toFixed(2)})` : ''));
        },
        cancelSync(pid, iid) { const p=this.data.plans.find(x=>x.id===pid), item=p.items.find(i=>i.id===iid); if(item.linkedRecordId)this.removeRecordGlobal(item.linkedRecordId); item.isSynced=false; item.linkedRecordId=null; this.saveData(); this.refreshPlanUI(p.type); this.loadDailyRecords(); this.toast('å·²å–æ¶ˆ'); },
        batchSyncPlan(pid) {
            const p = this.data.plans.find(x => x.id === pid); let c=0;
            p.items.forEach(i => { if(!i.isSynced && i.name && parseFloat(i.actual)>0) { const rid = Date.now()+c; let people = 1; if (p.type === 'budget') people = parseInt(i.people) || 1; const finalAmt = parseFloat(i.actual) / people; let noteText = p.type === 'budget' ? 'è®¡åˆ’' : 'å¤§é¢æ”¯å‡º'; if (i.remark && i.remark.trim() !== "") noteText += ` (${i.remark})`; if(people>1) noteText += ` (AA: ${people}äºº)`; if(!this.data.records[i.date])this.data.records[i.date]=[]; this.data.records[i.date].push({id:rid, l1:p.name, l2:i.name, note:noteText, amount:finalAmt, source:'plan', linkedPlanId:pid, linkedItemId:i.id}); i.isSynced=true; i.linkedRecordId=rid; c++; }});
            if(c>0) { this.saveData(); this.refreshPlanUI(p.type); this.loadDailyRecords(); this.toast(`å…¥è´¦ ${c} æ¡`); } else this.toast('æ— æœ‰æ•ˆé¡¹');
        },
        batchUnsyncPlan(pid) { this.confirm('å…¨éƒ¨å–æ¶ˆå…¥è´¦ï¼Ÿ', ()=>{ const p=this.data.plans.find(x=>x.id===pid); let c=0; p.items.forEach(i=>{if(i.isSynced){this.removeRecordGlobal(i.linkedRecordId);i.isSynced=false;i.linkedRecordId=null;c++}}); if(c>0){this.saveData();this.refreshPlanUI(p.type);this.loadDailyRecords();this.toast(`å–æ¶ˆ ${c} æ¡`);} }); },
        refreshPlanUI(type) { type === 'budget' ? this.renderBudgets() : this.renderProjects(); },
        // --- ä¿®å¤å›¾è¡¨æ˜¾ç¤ºï¼šé€‚é…ç§»åŠ¨ç«¯åŠå¾„ï¼Œé˜²æ­¢æ–‡å­—è¢«æˆªæ–­ ---
        showPlanChart(pid) {
            const p = this.data.plans.find(x => x.id === pid);
            if(!p || !p.items.length) return this.toast('æ— æ•°æ®å¯ç”Ÿæˆå›¾è¡¨', 'error');
            
            document.getElementById('chart-view-modal').style.display = 'flex';
            
            setTimeout(() => {
                const dom = document.getElementById('chart-view-container');
                let chart = echarts.getInstanceByDom(dom);
                if(chart) chart.dispose();
                chart = echarts.init(dom);
                this.data.currentChartInstance = chart;
                
                // è¿‡æ»¤å‡ºé‡‘é¢å¤§äº0çš„é¡¹ç›®
                const data = p.items.filter(i => parseFloat(i.actual) > 0).map(i => ({
                    name: i.name, 
                    value: parseFloat(i.actual)
                }));
                const total = data.reduce((s,i) => s + i.value, 0);
                
                // === å…³é”®ä¿®å¤ï¼šæ£€æµ‹å±å¹•å®½åº¦ ===
                const isMobile = window.innerWidth < 768;
                
                // ç§»åŠ¨ç«¯ä½¿ç”¨æ›´å°çš„åŠå¾„ (30%-50%)ï¼Œæ¡Œé¢ç«¯ä½¿ç”¨ (40%-65%)
                // è¿™æ ·èƒ½ç»™å·¦å³ä¸¤ä¾§çš„æ–‡å­—ç•™å‡ºæ›´å¤šç©ºé—´
                const radiusSetting = isMobile ? ['30%', '50%'] : ['40%', '65%'];
                
                const option = {
                    title: { 
                        text: p.name + (p.type==='budget' && p.totalBudget ? ` (é¢„ç®—: Â¥${p.totalBudget})` : ''), 
                        subtext: `æ€»æ”¯å‡º: Â¥${total.toFixed(2)}`, 
                        left: 'center', 
                        top: isMobile ? 10 : 20, // ç§»åŠ¨ç«¯æ ‡é¢˜é ä¸Šä¸€ç‚¹
                        textStyle: { fontSize: isMobile ? 18 : 24 } 
                    },
                    tooltip: { 
                        trigger: 'item', 
                        formatter: '{b}: Â¥{c} ({d}%)',
                        confine: true // é™åˆ¶æç¤ºæ¡†åœ¨å›¾è¡¨åŒºåŸŸå†…
                    },
                    legend: { 
                        bottom: 10, 
                        type: 'scroll' 
                    },
                    series: [{ 
                        type: 'pie', 
                        radius: radiusSetting, // åº”ç”¨åŠ¨æ€åŠå¾„
                        center: ['50%', '55%'], 
                        data: data, 
                        itemStyle: { 
                            borderRadius: 0, 
                            borderWidth: 0, 
                            borderColor: 'transparent' 
                        }, 
                        label: { 
                            show: true, 
                            formatter: '{b}: Â¥{c}\n({d}%)', 
                            fontSize: 12, 
                            lineHeight: 16,
                            edgeDistance: 10 // æ–‡å­—è·ç¦»è¾¹ç¼˜çš„è·ç¦»
                        }, 
                        // å…³é”®ä¿®å¤ï¼šç¼©çŸ­å¼•å¯¼çº¿é•¿åº¦ï¼ŒæŠŠæ–‡å­—æ‹‰è¿‘
                        labelLine: {
                            length: isMobile ? 10 : 20,
                            length2: isMobile ? 10 : 20,
                            maxSurfaceAngle: 80
                        },
                        avoidLabelOverlap: true 
                    }]
                };
                chart.setOption(option);
            }, 100);
        },
        saveCurrentChart() { if(!this.data.currentChartInstance) return; const url = this.data.currentChartInstance.getDataURL({type: 'png', pixelRatio: 2, backgroundColor: '#fff'}); const a = document.createElement('a'); a.href = url; a.download = `ç»Ÿè®¡å›¾è¡¨.png`; document.body.appendChild(a); a.click(); document.body.removeChild(a); this.toast('å›¾ç‰‡å·²ä¿å­˜', 'success'); },

        // --- æ ¸å¿ƒæ”¹åŠ¨ï¼šæ¸²æŸ“è®¡åˆ’å¡ç‰‡å¼æ˜ç»† (å¸ƒå±€é‡æ„ & æŠ˜å æ˜ç»†) ---
        renderPlanGroup(cid, type, pageInput = null) {
            const container = document.getElementById(cid); 
            const paginationId = type === 'budget' ? 'budget-pagination' : 'project-pagination'; const pagination = document.getElementById(paginationId);
            const pageSizeSelectId = type === 'budget' ? 'budget-page-size' : 'project-page-size'; const pageInfoId = type === 'budget' ? 'budget-page-info' : 'project-page-info';
            const pageState = type === 'budget' ? this.data.budgetPageState : this.data.projectPageState;
            if (pageInput) pageState.page = pageInput; pageState.pageSize = parseInt(document.getElementById(pageSizeSelectId)?.value || 5);

            container.innerHTML = ''; if (!this.data.plans) return;
            const list = this.data.plans.filter(p => (!p.type && type==='budget') || p.type === type).sort((a,b) => b.id - a.id);
            if (list.length === 0) { container.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8;font-style:italic">æš‚æ— ç›¸å…³è®¡åˆ’ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ–°å¢</div>'; pagination.style.display = 'none'; return; }
            const totalCount = list.length; const totalPages = Math.ceil(totalCount / pageState.pageSize);
            if(pageState.page > totalPages) pageState.page = totalPages; if(pageState.page < 1) pageState.page = 1;
            const startIdx = (pageState.page - 1) * pageState.pageSize; const pagedList = list.slice(startIdx, startIdx + pageState.pageSize);

            const groups = {}; pagedList.forEach(p => { if (!p.items) p.items = []; let y = p.year; if (!y) { try { y = new Date(p.id).getFullYear(); } catch(e) { y = 9999; } } if(!groups[y]) groups[y] = []; groups[y].push(p); });

            Object.keys(groups).sort((a,b)=>b-a).forEach(y => {
                const sep = document.createElement('div'); sep.className = 'year-separator'; sep.textContent = `${y}å¹´`; container.appendChild(sep);
                groups[y].forEach(p => {
                    const items = p.items || [];
                    const tItemBud = items.reduce((s,i)=>s+parseFloat(i.budget||0),0); const tAct = items.reduce((s,i)=>s+parseFloat(i.actual||0),0);
                    const displayTotal = (p.totalBudget && p.totalBudget > 0) ? p.totalBudget : tItemBud; const diff = displayTotal - tAct;
                    let diffHtml = '';
                    if (type === 'budget') {
                        const state = diff >= 0 ? `<span style="color:var(--success)">ç»“ä½™ Â¥${diff.toFixed(2)}</span>` : `<span style="color:var(--danger)">è¶…æ”¯ Â¥${Math.abs(diff).toFixed(2)}</span>`;
                        // é¢„ç®—é¡µé¢ï¼šæ˜¾ç¤º æ€»é¢„ç®— å·²èŠ± ç»“ä½™
                        diffHtml = `<div style="font-size:0.85rem;color:#64748b;">æ€»é¢„ç®— Â¥${displayTotal.toFixed(2)} å·²èŠ± Â¥${tAct.toFixed(2)} ${state}</div>`;
                    } else { 
                        // å¤§é¢æ”¯å‡ºï¼šæ˜¾ç¤º æ€»æ”¯å‡º
                        diffHtml = `<div style="font-size:0.95rem;color:var(--purple);font-weight:bold">æ€»æ”¯å‡º Â¥${tAct.toFixed(2)}</div>`; 
                    }
                    
                    const div = document.createElement('div'); div.className = `plan-card ${p.collapsed?'collapsed':''}`;
                    
                    // è¡¨å¤´ (æ¡Œé¢ç«¯æ˜¾ç¤ºï¼Œç§»åŠ¨ç«¯CSSæ§åˆ¶éšè—æˆ–è°ƒæ•´)
                    let headerRow = '';
                    if(type === 'budget') {
                         headerRow = `<div class="plan-items-header grid-budget-header"><div>åç§°</div><div>é¢„ç®—</div><div>å®é™…</div><div>äººæ•°</div><div>å¤‡æ³¨</div><div>æ—¥æœŸ</div><div>æ“ä½œ</div></div>`;
                    } else {
                         headerRow = `<div class="plan-items-header grid-project-header"><div>åç§°</div><div>å®é™…</div><div>å¤‡æ³¨</div><div>æ—¥æœŸ</div><div>æ“ä½œ</div></div>`;
                    }

                    // æ–°çš„å¤´éƒ¨ç»“æ„ï¼šä¸Šä¸‹ä¸¤è¡Œ
                    div.innerHTML = `
                        <div class="plan-header" onclick="app.togglePlan(${p.id})">
                            <div class="plan-header-top">
                                <div class="header-left">
                                    <span class="toggle-icon">â–¼</span>
                                    <strong style="font-size:1.1rem; color:${type==='budget'?'var(--primary)':'var(--purple)'}">${p.name}</strong>
                                    <span style="cursor:pointer;margin-left:8px;font-size:1.2rem;color:#64748b;" title="æŸ¥çœ‹å›¾è¡¨" onclick="event.stopPropagation();app.showPlanChart(${p.id})">ğŸ“Š</span>
                                </div>
                                <div class="header-right">${diffHtml}</div>
                            </div>
                            <div class="plan-header-actions" onclick="event.stopPropagation()">
                                <button class="btn btn-sm btn-primary" onclick="app.batchSyncPlan(${p.id})">å…¨éƒ¨å…¥è´¦</button>
                                <button class="btn btn-sm btn-warning" onclick="app.batchUnsyncPlan(${p.id})">å…¨éƒ¨å–æ¶ˆ</button>
                                <button class="btn btn-outline btn-sm" onclick="app.openPlanModal('edit', ${p.id})">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="app.deletePlan(${p.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="plan-items">
                            ${headerRow}
                            <div id="p-items-${p.id}"></div>
                            <button class="btn btn-outline btn-sm" style="width:100%;border-style:dashed;margin-top:10px" onclick="app.addPlanItem(${p.id})">+ å¢åŠ æ˜ç»†</button>
                        </div>`;
                    
                    const ic = div.querySelector(`#p-items-${p.id}`);
                    
                    // æ¸²æŸ“æ˜ç»†åˆ—è¡¨ (æ”¯æŒæŠ˜å )
                    items.forEach(item => {
                        const itemCard = document.createElement('div'); itemCard.className = 'plan-item-card collapsed'; // é»˜è®¤æŠ˜å 
                        
                        const nameHtml = `<div class="plan-item-input-group"><label>åç§°</label><input class="form-control" value="${item.name||''}" placeholder="é¡¹ç›®å" onchange="app.updatePlanItem(${p.id},${item.id},'name',this.value)" ${item.isSynced?'disabled':''}></div>`;
                        const budgetHtml = type==='budget' ? `<div class="plan-item-input-group"><label>é¢„ç®—</label><input type="number" class="form-control" value="${item.budget||0}" onchange="app.updatePlanItem(${p.id},${item.id},'budget',this.value)" ${item.isSynced?'disabled':''}></div>` : '';
                        const actualHtml = `<div class="plan-item-input-group"><label>å®é™…</label><input type="number" class="form-control" value="${item.actual||0}" onchange="app.updatePlanItem(${p.id},${item.id},'actual',this.value)" ${item.isSynced?'disabled':''}></div>`;
                        const peopleHtml = type==='budget' ? `<div class="plan-item-input-group"><label>äººæ•°</label><input type="number" class="form-control" value="${item.people||1}" min="1" placeholder="äººæ•°" onchange="app.updatePlanItem(${p.id},${item.id},'people',this.value)" ${item.isSynced?'disabled':''}></div>` : '';
                        const remarkHtml = `<div class="plan-item-input-group"><label>å¤‡æ³¨</label><input type="text" class="form-control" value="${item.remark||''}" placeholder="å¤‡æ³¨" onchange="app.updatePlanItem(${p.id},${item.id},'remark',this.value)" ${item.isSynced?'disabled':''}></div>`;
                        const dateHtml = `<div class="plan-item-input-group"><label>æ—¥æœŸ</label><input type="date" class="form-control" value="${item.date}" onchange="app.updatePlanItem(${p.id},${item.id},'date',this.value)" ${item.isSynced?'disabled':''}></div>`;
                        const btnsHtml = `<div class="plan-item-actions">${item.isSynced ? `<button class="btn btn-warning btn-sm" onclick="app.cancelSync(${p.id},${item.id})">å–æ¶ˆ</button>` : `<button class="btn btn-primary btn-sm" onclick="app.syncPlanItem(${p.id},${item.id})">å…¥è´¦</button>`}<button class="btn btn-danger btn-sm" onclick="app.deletePlanItem(${p.id},${item.id})">Ã—</button></div>`;

                        // ç§»åŠ¨ç«¯ï¼šæŠ˜å å¤´éƒ¨é€»è¾‘
                        const itemName = item.name || 'æœªå‘½å';
                        const itemAmount = parseFloat(item.actual || 0).toFixed(2);
                        
                        // ç»„è£…å†…å®¹
                        let inputsContent = '';
                        if(type === 'budget') {
                            inputsContent = `<div class="plan-item-row grid-budget-row">${nameHtml}${budgetHtml}${actualHtml}${peopleHtml}${remarkHtml}${dateHtml}${btnsHtml}</div>`;
                        } else {
                            inputsContent = `<div class="plan-item-row grid-project-row">${nameHtml}${actualHtml}${remarkHtml}${dateHtml}${btnsHtml}</div>`;
                        }

                        // æ’å…¥ HTMLï¼šåŒ…å«æŠ˜å å¤´ + éšè—çš„body
                        itemCard.innerHTML = `
                            <div class="plan-item-header" onclick="this.parentElement.classList.toggle('expanded')">
                                <div class="item-header-info"><span class="item-toggle-icon">â–¼</span>${itemName}</div>
                                <div class="item-header-amount">Â¥${itemAmount}</div>
                            </div>
                            <div class="plan-item-body">
                                ${inputsContent}
                            </div>
                        `;
                        ic.appendChild(itemCard);
                    });
                    container.appendChild(div);
                });
            });

            pagination.style.display = 'flex'; document.getElementById(pageInfoId).innerText = `ç¬¬ ${pageState.page} / ${totalPages} é¡µ (å…± ${totalCount} æ¡)`; const btns = pagination.querySelectorAll('button'); btns[0].disabled = pageState.page <= 1; btns[1].disabled = pageState.page >= totalPages;
        },
        changePlanPage(type, delta) { const pageState = type === 'budget' ? this.data.budgetPageState : this.data.projectPageState; const func = type === 'budget' ? 'renderBudgets' : 'renderProjects'; this[func](pageState.page + delta); },
        renderBudgets(page) { this.renderPlanGroup('budgets-container', 'budget', page); },
        renderProjects(page) { this.renderPlanGroup('projects-container', 'project', page); },

        // --- 3. åˆ†ææ ¸å¿ƒ (ä¿æŒä¸å˜) ---
        triggerAnalysis() { if(this.data.lastAnalysisSource === 'local') { this.analyzeLocalData(); } else if (this.data.lastAnalysisSource === 'files' && this.data.lastFiles) { this.analyzeFiles({files: this.data.lastFiles}, true); } },
        async analyzeLocalData() { this.data.lastAnalysisSource = 'local'; this.data.lastFiles = null; let allRows = []; Object.entries(this.data.records).forEach(([date, list]) => { list.forEach(r => allRows.push({ l1: r.l1, l2: r.l2, remark: r.note, amt: parseFloat(r.amount), date, source: r.source, linkedPlanId: r.linkedPlanId })); }); await this.processAnalysisData(allRows, "æœ¬åœ°è´¦æœ¬"); },
        async analyzeFiles(input, isRetry=false) { const files = Array.from(input.files).filter(f => f.name.endsWith('.xlsx')); if(!files.length) return this.toast('æ–‡ä»¶å¤¹å†…æœªæ‰¾åˆ°Excelæ–‡ä»¶', 'error'); this.data.lastAnalysisSource = 'files'; this.data.lastFiles = input.files; if(!isRetry) this.toast(`æ­£åœ¨åˆ†æ ${files.length} ä¸ªæ–‡ä»¶...`); let rows = []; for(const f of files) { try { const d = await f.arrayBuffer(); const wb = XLSX.read(d); const sheet = wb.Sheets[wb.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(sheet); json.forEach(r => { const amt = parseFloat(r['é‡‘é¢']||r['Amount']||0); if(amt) rows.push({ l1:r['ä¸€çº§åˆ†ç±»']||'æœªåˆ†ç±»', l2:r['äºŒçº§åˆ†ç±»']||'', remark:r['å¤‡æ³¨']||'', amt, date:r['æ—¥æœŸ']||'', source:r['æ¥æº']||'æ—¥å¸¸', isExternal: true }); }); } catch(e){ console.error(e); } } await this.processAnalysisData(rows, `å¤–éƒ¨ç›®å½• (${files.length}ä¸ªæ–‡ä»¶)`); },
        async processAnalysisData(rows, sourceName) { const startStr = document.getElementById('analysis-start').value, endStr = document.getElementById('analysis-end').value, start = startStr ? new Date(startStr) : null, end = endStr ? new Date(endStr) : null; const topN = parseInt(document.getElementById('analysis-top-n').value) || 10; let filtered = rows.filter(r => { if(!r.date) return true; const d = new Date(r.date); if(start && d < start) return false; if(end && d > end) return false; return true; }); this.data.currentAnalysisData = filtered; document.getElementById('analysis-result').style.display = 'block'; document.getElementById('stat-source-type').innerText = sourceName + (startStr?` (${startStr} ~ ${endStr||'è‡³ä»Š'})`:' (å…¨éƒ¨æ—¶é—´)'); document.getElementById('stat-total-amount').innerText = 'Â¥' + filtered.reduce((s,r)=>s+r.amt,0).toFixed(2); const l1Map={}, l2Map={}, budgetMap={}, projectMap={}; filtered.forEach(r => { l1Map[r.l1] = (l1Map[r.l1]||0)+r.amt; if(r.l2) l2Map[`${r.l1}-${r.l2}`] = (l2Map[`${r.l1}-${r.l2}`]||0)+r.amt; if(r.source==='plan' || r.source==='è®¡åˆ’') { let type = 'budget'; let planName = r.l1; if (r.linkedPlanId) { const p = this.data.plans.find(p => p.id === r.linkedPlanId); if (p) { planName = p.name; type = p.type; } } if(!r.linkedPlanId && r.isExternal) { const matchP = this.data.plans.find(p => p.name === planName); if(matchP) type = matchP.type; } if (type === 'budget') budgetMap[planName] = (budgetMap[planName]||0)+r.amt; else projectMap[planName] = (projectMap[planName]||0)+r.amt; } }); this.renderPieChart('chart-l1', 'ä¸€çº§åˆ†ç±»åˆ†å¸ƒ (Top ' + topN + ')', l1Map, topN); this.renderPieChart('chart-l2', 'äºŒçº§åˆ†ç±»åˆ†å¸ƒ (Top ' + topN + ')', l2Map, topN); const hasBudgets = Object.keys(budgetMap).length > 0; const hasProjects = Object.keys(projectMap).length > 0; document.getElementById('chart-budget').style.display = hasBudgets ? 'block' : 'none'; document.getElementById('rank-budget-box').style.display = hasBudgets ? 'block' : 'none'; if(hasBudgets) this.renderPieChart('chart-budget', 'é¢„ç®—è®¡åˆ’å æ¯”', budgetMap, topN); document.getElementById('chart-project').style.display = hasProjects ? 'block' : 'none'; document.getElementById('rank-project-box').style.display = hasProjects ? 'block' : 'none'; if(hasProjects) this.renderPieChart('chart-project', 'å¤§é¢æ”¯å‡ºå æ¯”', projectMap, topN); const fillTable = (id, map) => { const tbody = document.getElementById(id).querySelector('tbody'); const arr = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0, topN); const t = filtered.reduce((s,r)=>s+r.amt,0); tbody.innerHTML = arr.length ? arr.map(([k,v])=>`<tr><td>${k}</td><td>Â¥${v.toFixed(2)}</td><td>${((v/t)*100).toFixed(1)}%</td></tr>`).join('') : '<tr><td colspan="3" style="text-align:center">æ— æ•°æ®</td></tr>'; }; fillTable('rank-l1-table', l1Map); fillTable('rank-l2-table', l2Map); fillTable('rank-budget-table', budgetMap); fillTable('rank-project-table', projectMap); this.toast('åˆ†æå®Œæˆ', 'success'); },
        renderPieChart(domId, title, dataMap, topN) { const dom = document.getElementById(domId); if(!dom) return; let chart = echarts.getInstanceByDom(dom); if(chart) chart.dispose(); chart = echarts.init(dom); let sorted = Object.entries(dataMap).map(([name, value]) => ({name, value})).sort((a,b) => b.value - a.value); let finalData = []; if (sorted.length > topN) { finalData = sorted.slice(0, topN); const otherTotal = sorted.slice(topN).reduce((s, i) => s + i.value, 0); if(otherTotal > 0) finalData.push({ name: 'å…¶ä»–', value: otherTotal, itemStyle: { color: '#cbd5e1' } }); } else { finalData = sorted; } const option = { title: { text: title, left: 'center', top: 10, textStyle: { fontSize: 16 } }, tooltip: { trigger: 'item', formatter: '{b}: Â¥{c} ({d}%)' }, legend: { bottom: 0, left: 'center', type: 'scroll' }, series: [{ name: 'é‡‘é¢', type: 'pie', radius: ['40%', '65%'], avoidLabelOverlap: false, itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 }, label: { show: false, position: 'center' }, emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } }, data: finalData }] }; chart.setOption(option); },
        resizeCharts() { ['chart-l1', 'chart-l2', 'chart-budget', 'chart-project'].forEach(id => { const c = echarts.getInstanceByDom(document.getElementById(id)); if(c) c.resize(); }); },
        exportAnalysisReport() { if(!this.data.currentAnalysisData) return this.toast('è¯·å…ˆè¿›è¡Œåˆ†æ', 'error'); const data = this.data.currentAnalysisData; const l1Map={}, l2Map={}, budgetMap={}, projectMap={}; data.forEach(r => { l1Map[r.l1]=(l1Map[r.l1]||0)+r.amt; if(r.l2)l2Map[`${r.l1}-${r.l2}`]=(l2Map[`${r.l1}-${r.l2}`]||0)+r.amt; if(r.source==='plan'||r.source==='è®¡åˆ’') { let type='budget', name=r.l1; if(r.linkedPlanId) { const p=this.data.plans.find(x=>x.id===r.linkedPlanId); if(p){type=p.type; name=p.name;} } if(type==='budget') budgetMap[name]=(budgetMap[name]||0)+r.amt; else projectMap[name]=(projectMap[name]||0)+r.amt; } }); const toArr = (map) => Object.entries(map).sort((a,b)=>b-a).map(([k,v])=>({"é¡¹ç›®":k,"é‡‘é¢":v})); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(toArr(l1Map)), "ä¸€çº§åˆ†ç±»æ’è¡Œ"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(toArr(l2Map)), "äºŒçº§åˆ†ç±»æ’è¡Œ"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(toArr(budgetMap)), "é¢„ç®—è®¡åˆ’æ’è¡Œ"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(toArr(projectMap)), "å¤§é¢æ”¯å‡ºæ’è¡Œ"); XLSX.writeFile(wb, `åˆ†ææŠ¥è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`); this.toast('æŠ¥è¡¨å·²ä¸‹è½½', 'success'); },

        // --- åˆ†ç±»ç®¡ç† ---
        openCategoryModal() { const m = document.getElementById('category-modal'); m.innerHTML = `<div class="modal" style="width:550px"><div style="display:flex;justify-content:space-between;margin-bottom:15px;align-items:center;"><h3>ğŸ“‚ åˆ†ç±»ç®¡ç†</h3><div style="display:flex;gap:5px"><button class="btn btn-sm btn-outline" onclick="app.exportCategoriesConfig()" title="å¯¼å‡ºåˆ†ç±»é…ç½®">ğŸ“¤ å¯¼å‡º</button><button class="btn btn-sm btn-outline" onclick="app.importCategoriesConfig()" title="å¯¼å…¥åˆ†ç±»é…ç½®">ğŸ“¥ å¯¼å…¥</button><button class="btn btn-sm btn-outline" onclick="app.closeModal('category-modal')">âœ•</button></div></div><div id="category-manager-body" class="category-manager-container"></div><div style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:15px;"><div id="add-l1-wrapper"><button class="btn btn-primary" style="width:100%;" onclick="app.showAddL1Input()">+ æ·»åŠ ä¸€çº§åˆ†ç±»</button></div></div></div>`; m.style.display = 'flex'; this.renderCategoryManagerList(); },
        renderCategoryManagerList() { const container = document.getElementById('category-manager-body'); if(!container) return; container.innerHTML = ''; this.data.categories.forEach((cat, idx) => { const card = document.createElement('div'); card.className = 'cat-card'; const tagsHtml = cat.l2.map((sub, subIdx) => `<div class="tag-item"><span onclick="app.editL2(${idx}, ${subIdx}, '${sub}')" title="ç‚¹å‡»é‡å‘½å">${sub}</span><span class="tag-del-btn" onclick="app.delCatL2(${idx}, ${subIdx})">Ã—</span></div>`).join(''); card.innerHTML = `<div class="cat-header"><div class="cat-title" id="l1-title-${idx}"><span class="drag-handle">â‹®â‹®</span><span>${cat.l1}</span><span class="icon-btn-sm" onclick="app.editL1(${idx}, '${cat.l1}')">âœï¸</span></div><div class="cat-actions"><button class="btn btn-sm btn-danger" onclick="app.delCatL1(${idx})">åˆ é™¤</button></div></div><div class="tag-container" id="tag-container-${idx}">${tagsHtml}<button class="add-tag-btn" onclick="app.showAddL2Input(${idx})">+ æ–°å¢å­ç±»</button></div>`; container.appendChild(card); new Sortable(document.getElementById(`tag-container-${idx}`), { animation: 150, filter: '.add-tag-btn, .inline-input', onEnd: (evt) => { const item = this.data.categories[idx].l2.splice(evt.oldIndex, 1)[0]; this.data.categories[idx].l2.splice(evt.newIndex, 0, item); this.saveData(); this.updateL2Options(); } }); }); new Sortable(container, { animation: 150, handle: '.drag-handle', onEnd: (evt) => { const item = this.data.categories.splice(evt.oldIndex, 1)[0]; this.data.categories.splice(evt.newIndex, 0, item); this.saveData(); this.renderCategorySelects(); } }); },
        showAddL1Input() { const wrapper = document.getElementById('add-l1-wrapper'); wrapper.innerHTML = `<div style="display:flex; gap:10px;"><input type="text" id="new-l1-input" class="form-control" placeholder="è¾“å…¥ä¸€çº§åˆ†ç±»åç§°..." onkeydown="if(event.key==='Enter') app.saveNewL1()"><button class="btn btn-primary" onclick="app.saveNewL1()">ä¿å­˜</button><button class="btn btn-outline" onclick="app.resetAddL1Btn()">å–æ¶ˆ</button></div>`; setTimeout(() => document.getElementById('new-l1-input').focus(), 50); },
        resetAddL1Btn() { document.getElementById('add-l1-wrapper').innerHTML = `<button class="btn btn-primary" style="width:100%;" onclick="app.showAddL1Input()">+ æ·»åŠ ä¸€çº§åˆ†ç±»</button>`; },
        saveNewL1() { const val = document.getElementById('new-l1-input').value.trim(); if(!val) return this.toast('åç§°ä¸èƒ½ä¸ºç©º', 'error'); this.data.categories.push({ l1: val, l2: [] }); this.saveData(); this.renderCategoryManagerList(); this.resetAddL1Btn(); this.renderCategorySelects(); },
        editL1(idx, oldName) { const div = document.getElementById(`l1-title-${idx}`); div.innerHTML = `<input type="text" class="inline-input inline-input-lg" id="edit-l1-input-${idx}" value="${oldName}" onblur="app.saveEditL1(${idx})" onkeydown="if(event.key==='Enter') this.blur()">`; setTimeout(() => document.getElementById(`edit-l1-input-${idx}`).focus(), 50); },
        saveEditL1(idx) { const val = document.getElementById(`edit-l1-input-${idx}`).value.trim(); if(val) { this.data.categories[idx].l1 = val; this.saveData(); this.renderCategorySelects(); } this.renderCategoryManagerList(); },
        delCatL1(idx) { if(confirm(`ç¡®å®šåˆ é™¤â€œ${this.data.categories[idx].l1}â€åŠå…¶æ‰€æœ‰å­åˆ†ç±»å—ï¼Ÿ`)) { this.data.categories.splice(idx, 1); this.saveData(); this.renderCategoryManagerList(); this.renderCategorySelects(); } },
        showAddL2Input(idx) { const container = document.getElementById(`tag-container-${idx}`); container.querySelector('.add-tag-btn').style.display = 'none'; const span = document.createElement('div'); span.innerHTML = `<input type="text" class="inline-input" id="new-l2-input-${idx}" placeholder="åç§°" onblur="app.saveNewL2(${idx})" onkeydown="if(event.key==='Enter') this.blur()">`; container.appendChild(span); setTimeout(() => document.getElementById(`new-l2-input-${idx}`).focus(), 50); },
        saveNewL2(idx) { const input = document.getElementById(`new-l2-input-${idx}`); if(!input) return; const val = input.value.trim(); if(val) { this.data.categories[idx].l2.push(val); this.saveData(); this.updateL2Options(); } this.renderCategoryManagerList(); },
        editL2(catIdx, subIdx, oldName) { const newVal = prompt("é‡å‘½åå­åˆ†ç±»:", oldName); if(newVal && newVal.trim() !== "") { this.data.categories[catIdx].l2[subIdx] = newVal.trim(); this.saveData(); this.renderCategoryManagerList(); this.updateL2Options(); } },
        delCatL2(catIdx, subIdx) { this.data.categories[catIdx].l2.splice(subIdx, 1); this.saveData(); this.renderCategoryManagerList(); this.updateL2Options(); }
    };
    const app = App; app.init();
</script>
</body>
</html>